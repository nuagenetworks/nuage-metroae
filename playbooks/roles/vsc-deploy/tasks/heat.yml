---
- name: Get VSC details from OpenStack
  os_server_facts:
    auth:
      "{{ os_auth }}"
    server: "{{ inventory_hostname }}"
  register: vsc_server
  delegate_to: 127.0.0.1

- name: Set vsc mgmt ip
  set_fact:
    vsc_mgmt_ip: "{{ vsc_server['ansible_facts']['openstack_servers'][0]['networks'][vsc_mgmt_network][0] }}"

- name: Set vsc control ip
  set_fact:
    vsc_control_ip: "{{ vsc_server['ansible_facts']['openstack_servers'][0]['networks'][vsc_control_network][0] }}"

- name: Clean known_hosts of VSC's
  command: ssh-keygen -R "{{ vsc_mgmt_ip }}" -f /root/.ssh/known_hosts
  delegate_to: "{{ ansible_deployment_host }}"
  remote_user: "{{ ansible_sudo_user }}"

- block:
  - name: Get infra server details from OpenStack
    os_server_facts:
      auth:
        "{{ os_auth }}"
      server: "{{ infra_server_name }}"
    register: infra_server
    delegate_to: 127.0.0.1

  - name: Set infra ip
    set_fact:
      infra_ip: "{{ infra_server['ansible_facts']['openstack_servers'][0]['private_v4'] }}"

  - name: Update DNS entries
    lineinfile:
      line: "{{ vsc_mgmt_ip }}  {{ inventory_hostname }}"
      dest: /etc/hosts
    delegate_to: "{{ infra_ip }}"
    remote_user: "root"

  - name: Restart DNS service
    shell: service dnsmasq restart
    delegate_to: "{{ infra_ip }}"
    remote_user: "root"
  when: infra_server_name is defined

- name: Update /etc/hosts file on ansible host
  lineinfile:
    dest: /etc/hosts
    line: "{{ vsc_mgmt_ip }}    {{ inventory_hostname }}"
  delegate_to: 127.0.0.1
 
- name: Wait for VSC ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ vsc_mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1
  tags:
    - vsc
    - vsc-deploy

- name: Loading system config
  sros_config:
    src: config.cfg.j2
    provider: "{{ vsc_creds }}"
    save: yes
  delegate_to: 127.0.0.1

- name: Loading BOF config
  sros_config:
    lines:
      - bof address "{{ vsc_mgmt_ip }}/24"
      - bof primary-dns "{{ infra_ip | default(dns_server_list[0]) }}"
      - bof dns-domain "{{ dns_domain }}"
      - bof save "cf1:"
    provider: "{{ vsc_creds }}"
  delegate_to: 127.0.0.1

- name: Reboot VSC VM
  os_server_actions:
    auth:
      "{{ os_auth }}"
    server: "{{ inventory_hostname }}"
    action: reboot
    wait: no
  delegate_to: 127.0.0.1
