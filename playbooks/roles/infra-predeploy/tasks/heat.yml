---
- name: Get the public key for the current user
  local_action: command cat ~/.ssh/id_rsa.pub
  register: current_user_ssh_key

- name: Get heat stack for fixed ip deployments
  set_fact:
    infra_heat_template: "{{ playbook_dir }}/roles/infra-predeploy/files/infra_fixed.yml"
  when: dhcp == False

- name: Get heat stack for dhcp based deployments
  set_fact:
    infra_heat_template: "{{ playbook_dir }}/roles/infra-predeploy/files/infra.yml"
  when: dhcp == True

- name: Creating INFRA stack
  register: infra_stack
  os_stack:
    name: "{{ inventory_hostname }}"
    template: "{{ infra_heat_template }}"
    auth:
      "{{ os_auth }}"
    parameters:
      vm_name: "{{ inventory_hostname }}"
      infra_image: "{{ infra_image }}"
      infra_flavor: "{{ infra_flavor }}"
      infra_network: "{{ infra_network }}"
      infra_subnet: "{{ infra_subnet | default('NONE') }}"
      mgmt_ip: "{{ mgmt_ip | default('NONE') }}"
      ssh_key: "{{ current_user_ssh_key.stdout }}"
  delegate_to: 127.0.0.1
- debug: var=infra_stack['stack']['outputs'][0]['output_value']
