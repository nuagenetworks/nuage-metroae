---
- name: Pull facts on target_server
  setup: gather_subset=!all
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- name: List the Virtual Machines on target_server
  virt: command=list_vms
  register: virt_vms
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- block:
  - name: Destroy VSD VM
    virt:
      name: "{{ inventory_hostname }}"
      state: destroyed
      uri: qemu:///system
    delegate_to: "{{ target_server }}"
    remote_user: "{{ target_server_username }}"

  - name: Set VSD backup flag
    set_fact: backup_vsd="{{ preserve_vsd|default('False') }}"
  - block:
    - name: Create backup directory name
      set_fact: backup_dir="{{ images_path }}/{{ inventory_hostname }}.{{ ansible_date_time.date }}@{{ ansible_date_time.time }}"
    - name: Move the old VM image dir to the backup directory
      command: "mv {{ images_path }}/{{ inventory_hostname }}/ {{ backup_dir }}"
      delegate_to: "{{ target_server }}"
      remote_user: "{{ target_server_username }}"
    - name: Get XML for old VM
      virt:
        name: "{{ inventory_hostname }}"
        command: get_xml
        uri: qemu:///system
      register: vsd_xml
      delegate_to: "{{ target_server }}"
      remote_user: "{{ target_server_username }}"
    - debug: var=vsd_xml verbosity=1
    - name: Write VM XML to file
      copy:
        content: "{{ vsd_xml.get_xml }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}.xml"
      delegate_to: "{{ target_server }}"
      remote_user: "{{ target_server_username }}"
    when: backup_vsd

  - name: Undefine VSD VM
    virt:
      name: "{{ inventory_hostname }}"
      command: undefine
      uri: qemu:///system
    delegate_to: "{{ target_server }}"
    remote_user: "{{ target_server_username }}"
  when: inventory_hostname in virt_vms.list_vms

- name: Destroy the images directory
  file: path={{ images_path }}/{{ inventory_hostname }}
        state=absent
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"
