---
- name: Wait for VNS Utility VM ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- block:
  - name: Update /etc/hosts file on {{ target_server }}
    lineinfile:
      dest: /etc/hosts
      line: "{{ mgmt_ip }} {{ inventory_hostname }}"
    delegate_to: "{{ target_server }}"
    remote_user: "{{ target_server_username }}"
  when: not target_server_type | match("vcenter")

- name: Update /etc/hosts file
  blockinfile:
    dest: /etc/hosts
    block: |
      {% for host in groups['vnsutils']  %}
      {{ hostvars[host]['mgmt_ip'] }}    {{ host }}
      {% endfor %}
  remote_user: "root"

- name: Delete the localtime file
  file:
    path: /etc/localtime
    state: absent
  remote_user: "root"

- name: Create the localtime symlink
  file:
    src: /usr/share/zoneinfo/US/Pacific
    dest: /etc/localtime
    state: link
  remote_user: "root"

- name: Configure yum proxy
  lineinfile:
    dest: /etc/yum.conf
    line: "proxy={{ yum_proxy }}"
  remote_user: "root"
  when: not yum_proxy | match('NONE')

- name: Install NTP package on the vnsutil vm
  yum: name=ntp state=present
  remote_user: "root"

- name: Configure NTP servers
  lineinfile:
    dest: /etc/ntp.conf
    line: "server {{ item }} iburst"
  with_items: "{{ ntp_server_list }}"
  remote_user: "root"

- name: Stop the ntpd service if running
  service:
    name: ntpd
    state: stopped
  remote_user: "root"

- name: Manually sync time with ntp server
  command: ntpdate -u "{{ntp_server_list[0]}}"
  remote_user: "root"

- name: Start ntpd
  service:
    name: ntpd
    state: started
  remote_user: "root"

- name: check ntp sync state
  shell: ntpstat | awk 'NR==1{print $1}'
  register: sync_status
  until: sync_status.stdout == "synchronised"
  retries: 4
  delay: 5
  ignore_errors: yes
  remote_user: "root"

- block:
  - name: restart ntp if it hasn't synced yet
    command: service ntpd restart
    remote_user: "root"
  - name: check ntp sync state
    shell: ntpstat | awk 'NR==1{print $1}'
    register: retry_sync_status
    until: retry_sync_status.stdout == "synchronised"
    retries: 4
    delay: 5
    remote_user: "root"
  when: not sync_status.stdout | match("synchronized")

- block:
  - name: Install dhcp package
    yum: name=dhcp state=present
    remote_user: "root"

  - name: Copy dhcp config
    template: src=dhcpd.conf.j2 backup=no dest=/etc/dhcp/dhcpd.conf
    remote_user: "root"

  - name: Restart dhcp service
    service:
      name: dhcpd
      state: restarted
    remote_user: "root"

  - name: Chkconfig of dhcpd
    command: chkconfig dhcpd on
    remote_user: "root"

  - name: Install dnsmasq package
    yum: name=dnsmasq state=present
    remote_user: "root"

  - name: Copy dnsmasq config
    template: src=dnsmasq.conf.j2 backup=no dest=/etc/dnsmasq.conf
    remote_user: "root"

  - name: Start dnsmasq
    service:
      name: dnsmasq
      state: started
    remote_user: "root"

  - name: Chkconfig of dnsmasq
    command: chkconfig dnsmasq on
    remote_user: "root"
  when: nsgv_ip is defined or nsgv_mac is defined or nsgv_host_name is defined
