#!/usr/bin/env bash
set -ex
#
# Wrapper around ansible-playbook for the installation of Nuage components

PLAYBOOK=$1
shift

# Add .yml extension if needed
EXTENSION="${PLAYBOOK##*.}"
TAG="$(echo $PLAYBOOK | cut -d'_' -f 1)"
if [ "$EXTENSION" != "yml" ]; then
  PLAYBOOK=${PLAYBOOK}.yml
fi

if [ "$TAG" != "reset" ] && [ $PLAYBOOK != "build.yml" ] && [ $PLAYBOOK != "setup.yml" ]; then
  echo "Populating $TAG variables"
  ansible-playbook -i hosts handle_vars.yml "$@"
fi

if [[ -a $PLAYBOOK  ]]; then
  echo "Executing $PLAYBOOK"
  $(which ansible-playbook) -i hosts -e "@user_creds.yml" $PLAYBOOK "$@"
elif [[ -a ./playbooks/$PLAYBOOK ]]; then
  echo "Executing ./playbooks/$PLAYBOOK"
  $(which ansible-playbook) -i hosts wrapper.yml -e "@user_creds.yml" -e playbook=playbooks/$PLAYBOOK "$@"
else
  echo "Requested Metro-Playbook could not be found"
  exit 1
fi
