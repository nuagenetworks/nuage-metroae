--- 
- hosts: localhost
  gather_facts: no
  vars:
    ansible_deployment_host: 10.106.0.2
    ansible_sudo_username: jenkins
  tasks:
    - name: Delete Stacks, Subents and route entries
      command: "python ci_cleanup.py 1"
      register: cleanup
      remote_user: root
    
    - name: Check cleanup script for errors
      assert:
        that: "'ERROR' not in cleanup.stdout"
        msg: "ci_cleanup.py script has error. Refer ci_cleanup.log for more details"

    - debug: var="cleanup.stdout"

    - name: Delete /etc/hosts entries for correspoding subnets
      lineinfile:
        dest: "/etc/hosts"
        regexp: "{{ item }}"
        state: absent
      with_items: "{{ (cleanup.stdout|from_json).etc_entries }}"
      delegate_to: "{{ ansible_deployment_host }}"
      remote_user: "{{ ansible_sudo_username }}"
