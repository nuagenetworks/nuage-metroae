---

- name: Include OS specific variables
  include_vars: "../../vm-host/vars/{{ hostvars[host].ansible_os_family }}.yml"

- name: Find name of NSG-V QCOW2 File
  find: path="{{ nuage.unzipped_files_dir }}/vns/nsg"  pattern="ncpe_centos7.qcow2" recurse=yes
  register: rc_nsg_file
  delegate_to: localhost

- debug: var=rc_nsg_file verbosity=1

- name: Verify that a NSG QCOW2 file was found
  assert: {
    that: "{{ rc_nsg_file.matched }} > 0",
    msg: "Unable to find NSG VM image file"
  }
 
- name: Set NSG VM name and Qcow image name
  set_fact:
    vm_name: "{{ inventory_hostname }}"
    qcow_name: "{{ rc_nsg_file.files[0].path | basename }}"

- name: List the Virtual Machines running
  virt: command=list_vms
  register: virt_vms
  delegate_to: "{{ host }}"
  remote_user: "root"

- name: Set fact to check if NSG VM is running
  set_fact: nsg_running="{{ inventory_hostname in virt_vms.list_vms }}"
- debug: var=nsg_running verbosity=1

- name: Verify that the NSG VM is not already running ( add 'keep_existing_vms' to skip this check )
  assert:
    that: not nsg_running|bool or keep_existing_vms | default(false)
    msg: "{{ vm_name }} is already running on {{ host }}"

- block:
  - name: Create libvirt image directory
    file: path={{ nuage.images_path }}/{{ vm_name }}
          state=directory
          owner={{ libvirt.user }}
          group={{ libvirt.group }}

  - name: Copy the NSG qcow image to virt images directory, remotely
    copy: src={{ rc_nsg_file.files[0].path }}
          dest={{ nuage.images_path }}/{{ vm_name }}/{{ qcow_name }}
          owner={{ libvirt.user }}
          group={{ libvirt.group }}

  - name: "Define new NSG-V VM"
    virt: name="{{ vm_name }}"
          command=define
          xml="{{ lookup('template', 'nsgv.xml.j2') }}"
          uri=qemu:///system

  - name: "Run NSG-V VM"
    virt: name="{{ vm_name }}"
          state=running
          autostart=True
          uri=qemu:///system
    when: ansible_version.full | version_compare('2.3', '>=')

## JvB condition for the whole block 
  when: "not nsg_running"
  delegate_to: "{{ host }}"
  remote_user: "root"  
