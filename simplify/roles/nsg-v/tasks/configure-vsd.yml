---

- block:
  - name: Provision VSD
    nuage-import:
       vsd: "{{ nuage.vsds[0].mgmt_ip }}"
       organization: csp
       config:
          infrastructurevscprofiles:
            - { name: "VSC1", firstController: "{{ nuage.vscs[0].control_ip }}" }
            - { name: "VSC2", firstController: "{{ nuage.vscs[1].control_ip }}" }
            - { name: "VSC1+2", firstController: "{{ nuage.vscs[0].control_ip }}", secondController: "{{ nuage.vscs[1].control_ip }}" }
          infrastructuregatewayprofiles:
            - { name: "Infra", proxyDNSName: "proxy.{{ nuage.domain }}" }
          nsgatewaytemplates:
            - { name: "NSG-V", 
                infrastructureProfileID: "ID:infrastructuregatewayprofiles.Infra",
                nsporttemplates: [ 
                  { name : "WAN", userMnemonic : "uplink1", physicalName : "port1", portType : "NETWORK", VLANRange : "0",
                    vlantemplates : [ { value : 0, description : "untagged", associatedVSCProfileID : "ID:infrastructurevscprofiles.VSC1+2" } ] },
                  { name : "LAN", userMnemonic : "lan1",    physicalName : "port2", portType : "ACCESS", VLANRange : "0",
                    vlantemplates : [ { value : 0, description : "untagged" } ] }
                ]
              }
    register: output
  - debug: var=output
  - name: Provision NSGs and create ZFB .iso file for each
    nuage-import:
       vsd: "{{ nuage.vsds[0].mgmt_ip }}"
       organization: Test
       config:
          nsgateways:
            - { name : "{{hostvars[item].inventory_hostname_short}}", templateID : "{{ output.ids['nsgatewaytemplates.NSG-V'] }}",
                nsports: [ { name: "WAN", vlans: [ { value: 0, uplinkconnections: [{ 
					role: "PRIMARY", 
					mode: "Static", 
					address: "{{hostvars[item].ip}}",
                    gateway: "{{nuage.networks['data'].gateway}}", 
					netmask: "{{nuage.networks['data'].netmask}}", 
					DNSAddress: "{{nuage.dns_server_list[0]}}" }] } ] } ] }
          jobs:
            - { command: "GET_ZFB_INFO",
                parameters : { associatedEntityID : "ID:nsgateways.{{hostvars[item].inventory_hostname_short}}", associatedEntityType: "nsgateway", NSGType: "ANY", mediaType: "ISO" }
              }
    with_items: "{{ groups['nsgs'] }}"
    register: jobs

  - name: Collect ZFB iso mappings
    set_fact:
      nsg_2_iso: "{{ nsg_2_iso|default({}) | combine( { item.0 : item.1.job_results[ item.1.ids[ 'nsgateways.' + hostvars[item.0].inventory_hostname_short ] ] } ) }}"
    with_together:
      - "{{ groups['nsgs'] }}"
      - "{{ jobs.results }}"
  - debug: var=nsg_2_iso

  connection: local
