---

- name: Find name of QCOW2 File
  find: path="{{ nuage.unzipped_files_dir }}/{{ vm_role }}"  pattern="*.qcow2" recurse=yes
  register: qcow_file
  delegate_to: localhost

- debug: var=qcow_file verbosity=1

- name: Verify that a QCOW2 file was found
  assert: {
    that: "{{ qcow_file.matched }} > 0",
    msg: "Unable to find VM image file for {{ vm_role }}"
  }

- name: Register QCOW2 location
  set_fact:
    src: "{{ qcow_file.files[0].path }}"

- block:
  - name: Copy VM qcow to all hosts, once per host, but only if it does not exist
    copy: src="{{ src }}"
          dest="{{ nuage.images_path }}/{{ src | basename }}"
          force=no
  - name: Get list of partitions
    shell: "guestfish -r -a {{ nuage.images_path }}/{{ src | basename }} run : list-filesystems | grep -Ev '(unknown|swap)'"
    register: partitions_list
    changed_when: false

  - name: Check partition content
    shell: "guestfish -r -a {{ nuage.images_path }}/{{ src | basename }} run : mount {{ item.split(':')[0] }} / : ls /"
    register: partitions
    with_items: "{{ partitions_list.stdout_lines }}"
    changed_when: false

  - name: Find root partition
    set_fact:
      guestfish_mount: "{{ item.item.split(':')[0]}}"
    with_items: "{{ partitions.results }}"
    when: '"proc" in item.stdout'
    changed_when: false

  delegate_to: "{{ vm_host }}"
