---

- name: Wait for Proxy ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ ip }}"
    search_regex: OpenSSH
    delay: 1

- block:
  - name: Generate SSH key
    command: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
    args:
      creates: "/root/.ssh/id_rsa"

  - name: Get generated SSH keys
    command: cat /root/.ssh/id_rsa.pub
    register: ssh_key

  - name: Update /etc/hosts file for dnsmasq
    blockinfile:
      dest: /etc/hosts
      block: |
        {{ ip }}	{{ ansible_hostname }}
        {% for host in groups['vsds']  %}
        {{ hostvars[host].ip }}    {{ host }} {{ (nuage.vsds | length == 3) | ternary( 'xmpp.' + nuage.domain, '' ) }}
        {% endfor %}
        {% for host in groups['vscs']  %}
        {{ hostvars[host].ip }}    {{ host }}
        {% endfor %}
