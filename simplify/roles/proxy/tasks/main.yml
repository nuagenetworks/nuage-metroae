---

- name: Wait for Proxy ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ ansible_host }}"
    search_regex: OpenSSH
    delay: 1

- block:
  - name: Generate SSH key
    command: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
    args:
      creates: "/root/.ssh/id_rsa"

  - name: Update /etc/hosts file for dnsmasq
    blockinfile:
      dest: /etc/hosts
      block: |
        {{ ansible_host }}	{{ inventory_hostname }}
        {% for host in groups['vsds']  %}
        {{ hostvars[host].ansible_host }}    {{ host }} {{ (nuage.vsds | length == 3) | ternary( 'xmpp.' + nuage.domain, '' ) }}
        {% endfor %}
        {% for host in groups['vscs']  %}
        {{ hostvars[host].ansible_host }}    {{ host }}
        {% endfor %}

  - name: Configure yum proxy
    lineinfile:
      dest: /etc/yum.conf
      regexp: "^proxy="
      line: "proxy={{ nuage.http_proxy }}"
    when: nuage.http_proxy is defined

  - name: Configure ntpd and ntpdate and local time zone
    include_role:
      name: common
      tasks_from: linux-ntp

  - name: Install dnsmasq package
    yum: name=dnsmasq state=present

  - name: Update /etc/dnsmasq.conf
    blockinfile:
      dest: /etc/dnsmasq.conf
      block: |
      #
      # Stop PTR queries from being passed upstream, speeds up ssh login
      #
      local=/in-addr.arpa/

      {% for host in groups['vsds']  %}
      srv-host=_xmpp-client._tcp.xmpp.{{nuage.domain}},{{host}},5222
      {% endfor }

  - name: Start dnsmasq
    service:
      name: dnsmasq
      enabled: true
      state: started
