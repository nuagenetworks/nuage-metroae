---

- block:
  - name: Copy VSD QCOW2 variables locally on {{ vsd_host }}
    set_fact:
      vsd_qcow2_path: "{{ hostvars['localhost'].vsd_qcow2_path }}"
      vsd_qcow2_file_name: "{{ hostvars['localhost'].vsd_qcow2_file_name }}"
  - name: Copy VSD qcow to all VSD hosts, once per host, but only if it does not exist
    copy: src="{{ vsd_qcow2_path }}/{{ vsd_qcow2_file_name }}"
          dest="{{ nuage.images_path }}/{{ vsd_qcow2_file_name }}"
          force=no
  - name: Get list of partitions
    shell: "guestfish -r -a {{ nuage.images_path }}/{{ vsd_qcow2_file_name }} run : list-filesystems | grep -Ev '(unknown|swap)'"
    register: partitions_list

  - name: Check partition content
    shell: "guestfish -r -a {{ nuage.images_path }}/{{ vsd_qcow2_file_name }} run : mount {{ item.split(':')[0] }} / : ls /"
    register: partitions
    with_items: "{{ partitions_list.stdout_lines }}"

  - name: Find root partition
    set_fact:
      guestfish_mount: "{{ item.item.split(':')[0]}}"
    with_items: "{{ partitions.results }}"
    when: '"proc" in item.stdout'

  delegate_to: "{{ vsd_host }}"
  delegate_facts: True
