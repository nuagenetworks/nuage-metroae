---

- block:

  - name: Store Nuage variables in hostvars for localhost, allow '//' for comments
    set_fact:
      nuage: "{{ lookup('file','nuage.json') | regex_replace( '[^:]//(.*)' ) | from_json }}"

  - name: Check for valid VSD configuration
    assert:
      that: (nuage.vsds | length == 1) or (nuage.vsds | length == 3)
      msg:  "A VSD config must consist of either 1 or 3 nodes"

  - name: Store default VMWare Datastore
    set_fact:
      vmware_ds: "{{ ( nuage.vcenter is defined ) | ternary( nuage.vcenter.datastore | default(''), '' ) }}"
  tags: always

- name: Process VSD hosts
  include_tasks: add-hosts.yml
  vars:
    vms: "{{ nuage.vsds }}"
    vm_hostname: "{{ (nuage.vsds | length == 3) | ternary( 'vsd%1d', 'vsd' ) }}"
    group: "vsds"
  tags: always
  
- name: Process VSC hosts
  include_tasks: add-hosts.yml
  vars:
    vms: "{{ nuage.vscs }}"
    vm_hostname: 'vsc%02d'
    ansible_user: "admin"
    group: "vscs"
  tags: vsc

- name: Process ES hosts (optional)
  include_tasks: add-hosts.yml
  vars:
    vms: "{{ nuage.stats }}"
    vm_hostname: 'es%1d'
    group: "ess"
  tags: es
  when: nuage.stats is defined

- name: Process VRS hosts (optional)
  include_tasks: add-vrs-hosts.yml
  vars:
    name: "{{ 'p' + item.0 | string + '-vrs%1d' }}"
  tags: vrs
  with_indexed_items: "{{ nuage.vrs }}"
  loop_control:
    loop_var: vrs_group
  when: nuage.vrs is defined

  
- name: Process Proxy VM host (optional)
  include_tasks: add-hosts.yml
  vars:
    vms: "[ {{ nuage.proxy }} ]"
    vm_hostname: 'proxy'
    group: "proxy"
  tags: proxy
  when: nuage.proxy is defined

- name: Process NSG hosts (optional)
  include_tasks: add-hosts.yml
  vars:
    vms: "{{ nuage.nsgs }}"
    vm_hostname: 'nsg%02d'
    ansible_user: "nuage"
    ansible_port: 893
    group: "nsgs"
  tags: nsg
  when: nuage.nsgs is defined
