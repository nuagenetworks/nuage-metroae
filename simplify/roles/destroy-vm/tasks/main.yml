---
- block:
  - name: List the Virtual Machines on {{ host }}
    virt: command=list_vms
    register: virt_vms
  
  - block:
    - name: Destroy the VM
      virt:
        name: "{{ inventory_hostname }}"
        state: destroyed
        uri: qemu:///system
 
    - name: Undefine VM
      virt:
        name: "{{ inventory_hostname }}"
        command: undefine
        uri: qemu:///system
    when: inventory_hostname in virt_vms.list_vms

  delegate_to: "{{ host }}"
  remote_user: "root"

