---

- hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - init

- hosts: servers
  gather_facts: yes
  roles:
    - { role: vm-host, tags: [ 'vsd', 'predeploy', 'vsc' ] }

# Deploy proxy first, set it up as DNS/DHCP server
- hosts: proxy
  gather_facts: no
  tags: [ 'proxy', 'predeploy' ]
  tasks:
    - name: Create Proxy Linux VM for {{ inventory_hostname }}
      include_role:
        name: vm
        tasks_from: create-kvm
      vars:
        vm_role: "vns/utils"
        hosts:  "{{ nuage.hosts[ nuage.proxy.host_index ] }}"
        vcpus:  "{{ proxy_vcpus }}"
        ram_gb: "{{ proxy_ram_gb }}"
        data_nic: true
      when: not on_vmware

- hosts: vsds
  gather_facts: no
  tags: [ 'vsd', 'predeploy' ]
  tasks:
    - name: Create VSD Linux VM for {{ inventory_hostname }}
      include_role:
        name: vm
        tasks_from: create-kvm
      vars:
        vm_role: "vsd"
        hosts:  "{{ nuage.vsds | map(attribute='host_index') | list | map('extract',nuage.hosts) | list | unique }}"
        vcpus:  "{{ vsd_vcpus }}"
        ram_gb: "{{ vsd_ram_gb }}"
      when: not on_vmware

- hosts: vsds
  serial: 1
  gather_facts: no
  roles:
    - { role: vsd, tags: [ 'vsd', 'install' ] }

- hosts: vscs
  gather_facts: no
  tags: [ 'vsc', 'predeploy' ]
  tasks:
    - name: Create and configure VSC Linux VM for {{ inventory_hostname }}
      include_role:
        name: vsc
        tasks_from: create-linux-vm
      when: not on_vmware
    - name: Create and configure VSC ESXi VM for {{ inventory_hostname }}
      include_role:
        name: vsc
        tasks_from: create-vmware-vm
      when: on_vmware
    - name: Finalize VSC config
      include_role:
        name: vsc

- hosts: ess
  gather_facts: no
  tags: [ 'es', 'predeploy' ]
  tasks:
    - name: Create ES Linux VM for {{ inventory_hostname }}
      include_role:
        name: vm
        tasks_from: create-kvm
      vars:
        vm_role: "vstat"
        hosts:  "{{ nuage.stats | map(attribute='host_index') | list | map('extract',nuage.hosts) | list | unique }}"
        vcpus:  "{{ es_vcpus }}"
        ram_gb: "{{ es_ram_gb }}"
      when: not on_vmware
    - name: Install ES
      include_role: 
        name: es

- hosts: vrs
  gather_facts: yes
  roles:
    - { role: vrs, tags: [ 'vrs', 'install' ] }

- hosts: nsgs
  gather_facts: no
  tags: [ 'nsg' ]
  tasks:
    - name: Configure VSD for NSGs
      include_role:
        name: nsg-v
        tasks_from: configure-vsd
      run_once: true
    - name: Create NSG-V Linux VM for {{ inventory_hostname }}
      include_role:
        name: nsg-v
        tasks_from: create-linux-vm
      when: not on_vmware
