---
# TODO:
# Check for existing stack or vms

- name: Print working directory
  local_action: command pwd
  register: directory

- name: Set Top-Level-Directory
  set_fact: tld="{{ role_path }}/../../"

- name: Create subnet in VSD
  local_action: command python {{ role_path }}/files/create_subnet.py {{ tld }}/
  register: vsd_subnet_id
  run_once: true

- name: Search for errors in the subnet creation script
  fail: msg={{ vsd_subnet_id.stdout }}
  when: vsd_subnet_id.stdout | search("(?i)ERROR")

- name: Get the public key for the current user
  local_action: command cat ~/.ssh/id_rsa.pub
  register: current_user_ssh_key

- name: Create VSD managed subnet, CI slave VM in OpenStack for Centos 7 VRS
  register: create_stack
  os_stack:
    name: "{{ inventory_hostname }}"
    template: "{{ role_path }}/files/ci_slave.yml"
    auth:
      "{{ os_auth }}"
    parameters:
      vm_name: "{{ inventory_hostname }}"
      ci_image: "{{ ci_image }}"
      ci_flavor: "{{ ci_flavor }}"
      ssh_key: "{{ current_user_ssh_key.stdout }}"
      subnet_name: "{{ (vsd_subnet_id.stdout|from_json).subnet_name }}"
      network_name: "{{ (vsd_subnet_id.stdout|from_json).net_name }}"
      cidr: "{{ (vsd_subnet_id.stdout|from_json).vsd_net }}/24"
      nuage_netid: "{{ (vsd_subnet_id.stdout|from_json).sub_id }}"
      nuage_partition: "{{ org_name }}"
  delegate_to: 127.0.0.1
  when: '"jen-centos" in ci_image'

- debug: var=create_stack['stack']['outputs'][0]['output_value']
  when: '"jen-centos" in ci_image'

- name: Stat the heat template
  stat:
    path: "{{ role_path }}/files/ci_slave_ubuntu.yml"
  delegate_to: localhost
  register: heat_template

- name: Verify that the heat template exists
  assert:
    that: "heat_template.stat.exists"
    msg:  "Heat teamplate not found. Quitting..."

- name: Create CI slave VMs in OpenStack for Ubuntu VRSs
  register: create_stack
  os_stack:
    name: "{{ inventory_hostname }}"
    template: "{{ role_path }}/files/ci_slave_ubuntu.yml"
    auth:
      "{{ os_auth }}"
    parameters:
      vm_name: "{{ inventory_hostname }}"
      ci_image: "{{ ci_image }}"
      ci_flavor: "{{ ci_flavor }}"
      ssh_key: "{{ current_user_ssh_key.stdout }}"
      subnet_name: "{{ (vsd_subnet_id.stdout|from_json).subnet_name }}"
      network_name: "{{ (vsd_subnet_id.stdout|from_json).net_name }}"
      cidr: "{{ (vsd_subnet_id.stdout|from_json).vsd_net }}/24"
      nuage_netid: "{{ (vsd_subnet_id.stdout|from_json).sub_id }}"
      nuage_partition: "{{ org_name }}"
  delegate_to: 127.0.0.1
  when: ci_image == 'jen-ubuntu14' or ci_image == 'jen-ubuntu16'

- debug: var=create_stack['stack']['outputs'][0]['output_value']
  when: ci_image == 'jen-ubuntu14' or ci_image == 'jen-ubuntu16'
