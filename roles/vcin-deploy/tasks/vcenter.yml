---
- name: Wait for VCIN ssh to be ready
  connection: local
  wait_for:
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1

- name: Update /etc/hosts file 
  blockinfile:
    dest: /etc/hosts
    block: |
      {% for host in groups['vcins']  %}
      {{ hostvars[host]['mgmt_ip'] }}    {{ host }}
      {% endfor %}
  remote_user: "root"

- name: Delete the localtime file
  file:
    path: /etc/localtime
    state: absent
  remote_user: "root"

- name: Create the localtime symlink
  file:
    src: /usr/share/zoneinfo/{{ timezone }}
    dest: /etc/localtime
    state: link
  remote_user: "root"

- name: Copy files to pin OS version
  copy:
    src: ./roles/vcin-deploy/files/
    dest: /etc/yum.repos.d/
  remote_user: "root"
  when: yum_pin

- name: Configure yum proxy
  lineinfile:
    dest: /etc/yum.conf
    line: "proxy={{ yum_proxy }}"
  remote_user: "root"
  when: yum_proxy != 'NONE'

- name: Execute a yum update 
  yum:
    name: '*'
    state: latest
  remote_user: "root"
  when: yum_update

- name: Remove old NTP servers
  lineinfile:
    dest: /etc/ntp.conf
    regexp: "^server"
    state: absent
  remote_user: "root"

- name: Configure NTP servers
  lineinfile:
    dest: /etc/ntp.conf
    line: "server {{ item }} iburst"
  with_items: "{{ ntp_server_list }}"
  remote_user: "root"

- name: Stop chronyd if running
  systemd:
    name: chronyd
    state: stopped
  remote_user: "root"
  ignore_errors: yes

- name: Disable chronyd if running
  systemd:
    name: chronyd
    enabled: no
  remote_user: "root"
  ignore_errors: yes

- name: Stop the ntpd service if running
  systemd:
    name: ntpd
    state: stopped
  remote_user: "root"

- name: Manually sync time with ntp server
  command: ntpdate -u "{{ntp_server_list[0]}}"
  remote_user: "root"

- name: Delete the default steptickers file
  file:
    path: /etc/ntp/step-tickers
    state: absent
  remote_user: "root"

- name: Configure NTP servers for ntpdate
  lineinfile:
    dest: /etc/ntp/step-tickers
    line: "{{ item }}"
    create: yes
  with_items: "{{ ntp_server_list }}"
  remote_user: "root"

- name: Enable ntpdate
  service:
    name: ntpdate
    enabled: yes
    state: started
  remote_user: "root"

- name: Start ntpd
  systemd:
    name: ntpd
    state: started
  remote_user: "root"

- name: Enable ntpd
  systemd:
    name: ntpd
    enabled: on
  remote_user: "root"

- name: check ntp sync state
  shell: ntpstat | awk 'NR==1{print $1}'
  register: sync_status
  until: sync_status.stdout == "synchronised"
  retries: 4
  delay: 5
  ignore_errors: yes
  remote_user: "root"

- name: Disable cloud-init on VCIN, to avoid boot time delays
  command: chkconfig cloud-init off
  remote_user: "root"

- block:
  - name: Find location of CloudMgmt rpm
    find: path="/opt/vsd/Packages/"  pattern="CloudMgmt-vmware*rpm" recurse=yes
    register: rc_cloudmgmt_rpm

  - name: install CloudMgmt rpm for create dvSwitch script
    yum:
      name: {{ rc_cloudmgmt_rpm.files[0].path }}
      state: present

  - name: Create dvSwitch if specified
    command: >
      /opt/vsd/CloudMgmt-vmware/cli.bash create_dvswitch --num-portgroup-ports 128 --num-portgroups 1 -u {{ vcenter.username }}
        -p {{ vcenter.password }} -r {{ vcenter.cluster }} --provider-vdc-id 1 --url https://{{ target_server }}/sdk
    chdir: /opt/vsd/CloudMgmt-vmware
  remote_user: "root"
  when: vcenter.create_dvs

- block:
  - name: restart ntp if it hasn't synced yet
    systemd:
      name: ntpd
      state: restarted
    remote_user: "root"
  - name: check ntp sync state
    shell: ntpstat | awk 'NR==1{print $1}'
    register: retry_sync_status
    until: retry_sync_status.stdout == "synchronised"
    retries: 4
    delay: 5
    remote_user: "root"
  when: sync_status.stdout != "synchronized"

- name: Install VCIN software
  command: /opt/vsd/vsd-install.sh -t s -y
  remote_user: "root"
