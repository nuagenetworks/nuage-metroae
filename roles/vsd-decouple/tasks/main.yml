---
- block:
  - name: List VSD-related mounts
    shell: "mount | grep VSD | grep /media/CDROM"
    register: mount_file
    remote_user: root
  
  - name: Print mount output when verbosity >= 1
    debug: var=mount_file verbosity=1

  - name: Verify that the ISO is mounted
    assert:
      that:
        - "'iso' in mount_file.stdout"
      msg: "Did not find iso file in mount path"

  - name: Decouple VSD Node2
    command: "/media/CDROM/decouple.sh -y"
    remote_user: root
  
  - name: Pause for decoulping to finish
    pause:
      seconds: 10

  - name: Execute list_p1db command on node2
    command: "{{ p1db_cmd }}"
    register: list_p1db_output

  - name: Print ejabberd list_p1db output when verbosity >= 1
    debug: var=list_p1db_output verbosity=1
 
  - name: Create local variable with p1db output to json
    set_fact: ejabberd_p1db_json="{{ list_p1db_output.stdout|ejabberd_p1db_to_json }}"
  
  - name: Write p1bd JSON to file
    nuage_append: filename="{{ report_filename }}" text="{{ inventory_hostname }} {{ ejabberd_p1db_json|to_nice_json }}\n"
    delegate_to: localhost

  - name: Verify the ejabbered p1db output is empty string
    assert:
      that: "not ejabberd_p1db_json['p1db_users']"
      msg: "Ejabbered is not decoupled"

  - name: Execute list_cluster command on node2
    command: "{{ ejabber_decouple }}"
    register: list_cluster_output
    
  - name: Print ejabberd list_cluster output when verbosity >= 1
    debug: var=list_cluster_output verbosity=1

  - name: Create local variable with ejabberd cluster output to json
    set_fact: ejabberd_cluster_json="{{ list_cluster_output.stdout|ejabberd_cluster_to_json }}"
  
  - name: Write cluster JSON to file
    nuage_append: filename="{{ report_filename }}" text="{{ inventory_hostname }} {{ ejabberd_cluster_json|to_nice_json }}\n"
    delegate_to: localhost

  - name: Veriy cluster output lists only itself
    assert:
      that: 
        - "'ejabberd@{{ inventory_hostname }}' == ejabberd_cluster_json['cluster_users'][0]"
        - "ejabberd_cluster_json['cluster_users'] | length == 1" 
      msg: "Ejabberd is not decoupled successfully"
 
  - name: Excute connected_users command on node2
    command: "{{ connected_users }}"
    register: client_list
    until: client_list.stdout.find("cna") != -1
    retries: 10
    delay: 20

  - name: Print ejabberd connected_users output when verbosity >= 1
    debug: var=client_list verbosity=1

  - name: Create local variable with ejabberd connected clients to json
    set_fact: ejabberd_clients_json="{{ client_list.stdout|ejabberd_clients_to_json }}"
  
  - name: Write clients JSON to file
    nuage_append: filename="{{ report_filename }}" text="{{ inventory_hostname }} {{ ejabberd_clients_json|to_nice_json }}\n"
    delegate_to: localhost

  - name: Verify ejabbered does not contain clients other that itself
    assert:
      that: "ejabberd_clients_json['connected_clients'] | length == 3"
      msg: " Ejabberd has more than 3 connected clients than itself" 
  when: inventory_hostname == groups['vsds'][1]
