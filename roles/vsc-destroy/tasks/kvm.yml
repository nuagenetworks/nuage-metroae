---
- name: List the Virtual Machine
  virt: command=list_vms
  register: virt_vms
  remote_user: "{{ target_server_username }}"
  delegate_to: "{{ target_server }}"

- name: Destroy VSC VM
  remote_user: "{{ target_server_username }}"
  delegate_to: "{{ target_server }}"
  virt:
    name: "{{ vmname | default(inventory_hostname) }}"
    state: destroyed
    uri: qemu:///system
  when: vmname | default(inventory_hostname) in virt_vms.list_vms

- name: Undefine VSC VM
  remote_user: "{{ target_server_username }}"
  delegate_to: "{{ target_server }}"
  virt:
    name: "{{ vmname | default(inventory_hostname) }}"
    command: undefine
    uri: qemu:///system
  when: vmname | default(inventory_hostname) in virt_vms.list_vms

- name: Destroy the images directory
  remote_user: "{{ target_server_username }}"
  delegate_to: "{{ target_server }}"
  file:
    path: "{{ images_path }}/{{ inventory_hostname }}"
    state: absent
