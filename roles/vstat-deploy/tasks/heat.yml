---
- name: Set VSTAT IP address
  include: set-vstat-ip.yml

- name: Clean known_hosts of VSTAT's
  known_hosts:
    name: "{{ vstat_mgmt_ip }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- include: manage-infra-server.yml
  when: infra_server_name is defined

- name: Pause for ssh port to be active
  pause:
    seconds: 5

- block:
  - name: Add a DNS server to eth0
    lineinfile:
      dest: /etc/sysconfig/network-scripts/ifcfg-eth0
      line: "DNS1={{ dns_server_list[0] }}"

  - name: Restart networking
    command: /etc/init.d/network restart

  - name: Setup VSD hostname
    hostname:
      name: "{{ hostname }}"

  - name: Update /etc/hosts file
    lineinfile:
      dest: /etc/hosts
      line: "{{ vstat_mgmt_ip }}  {{ inventory_hostname }}"

  remote_user: "{{ vstat_username }}"

- include: install_and_enable_stats.yml
