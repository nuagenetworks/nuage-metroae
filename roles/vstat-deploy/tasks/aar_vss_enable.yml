---
- block:

  - name: Create SSL directory on the Stats node
    file: path=/etc/nginx/ssl state=directory owner=root group=root mode=600

  - name: Revoke old stats cert, if any
    command: "/opt/vsd/ejbca/deploy/certMgmt.sh -a revoke -u elastic"
    remote_user: "{{ vsd_username }}"
    delegate_to: "{{ vsd_fqdn }}"
    ignore_errors: yes
  
  remote_user: "{{ vstat_username }}"

- block:

  - name: Generate SSL certificates on VSD for the Stats node
    include_role:
      name: common
      tasks_from: vsd-generate-transfer-certificates
    vars:
      certificate_password: "{{ vstat_password }}"
      certificate_username: elastic
      commonName: elastic
      certificate_type: server
      scp_user: "{{ vstat_username }}"
      scp_location: ~
      additional_parameters:  -d {{ inventory_hostname }}    

