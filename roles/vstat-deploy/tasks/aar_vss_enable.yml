---
- block:

  - name: Create SSL directory on the Stats node
    file: path=/etc/nginx/ssl state=directory owner=root group=root mode=600

  - name: Revoke old stats cert, if any
    command: "/opt/vsd/ejbca/deploy/certMgmt.sh -a revoke -u elastic"
    remote_user: "{{ vsd_username }}"
    become: "{{ 'no' if vsd_username == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_password }}"
    delegate_to: "{{ vsd_fqdn }}"
    ignore_errors: yes
  
  remote_user: "{{ vstat_username }}"

- name: Set local variables
  set_fact:
    dest: /tmp/ssl/
    pem_list:
      - elastic-CA.pem
      - elasticCert.pem
      - elastic-Key.pem
      - elastic.pem       

- block:
  - name: Generate SSL certificates on VSD for the Stats node
    include_role:
      name: common
      tasks_from: vsd-generate-transfer-certificates
    vars:
      certificate_password: "{{ vstat_password }}"
      certificate_username: elastic
      commonName: elastic
      certificate_type: server
      additional_parameters:  -d {{ mgmt_ip }}    

  - name: Create temp folder to host the ssl certificates
    local_action: file path={{ dest }} state=directory mode=755

  - name: Transfer SSL certificates from VSD to localhost
    fetch: src=/opt/vsd/ejbca/p12/pem/{{ item }} dest={{ dest }} flat=yes
    with_items: "{{ pem_list }}"
    remote_user: "{{ vsd_username }}"
    delegate_to: "{{ groups['vsds'][0] }}"
    become: "{{ 'no' if vsd_username == 'root' else 'yes' }}"
    vars:
      ansible_become_pass: "{{ vsd_password }}"

  run_once: True

- name: Transfer SSL certificates from localhost to Stats node
  copy: src={{ dest }}{{ item }} dest=/etc/nginx/ssl
  with_items: "{{ pem_list }}"
  remote_user: "{{ vstat_username }}"

- name: Delete temp folder from localhost
  local_action: file path={{ dest }} state=absent
  run_once: True
  
- name: Restart nginx process on Stats node
  systemd:
    name: nginx
    state: restarted
  remote_user: "{{ vstat_username }}"
  
