- name: run show version on remote devices
  local_action:
    module: sros_command
    commands: show system license
    wait_for: result[0] contains sros
    provider: "{{ cli }}"
  register: vsr_license_info
  remote_user: "{{ target_server_username }}"
  delegate_to: "{{ target_server }}"

- debug: var=vsr_license_info verbosity=1

- name: Check if license is valid
  fail: msg='VSR reports about "missing license record". Try redeploy with valid license file.'
  when: '"License status : card reboot pending, missing license record" == vsr_license_info.stdout_lines[0][3]'

- name: Set system name
  local_action:
    module: sros_config
    lines:
        - configure system name "{{ inventory_hostname }}"
    provider: "{{ cli }}"

- name: Set ssh preserve-key
  local_action:
    module: sros_config
    lines:
        - configure system security ssh preserve-key
    provider: "{{ cli }}"

- name: Set ntp servers
  local_action:
    module: sros_config
    lines:
        - configure system time ntp server {{ item }}
    provider: "{{ cli }}"
  with_items: '{{ ntp_server_list }}'

- name: Configure VSR cards
  local_action:
    module: sros_config
    lines:
      - configure card 1 card-type iom-v
      - configure card 1 mda 1 mda-type m20-v
    provider: "{{ cli }}"

- debug: msg='{{ lookup("file", deploy_cfg_file ).split('\n') }}' verbosity=1

- name: Configure VSR from deploy_cfg_file
  local_action:
    module: sros_config
    lines: '{{ lookup("file", deploy_cfg_file ).split("\n") }}'
    provider: "{{ cli }}"
  when: deploy_cfg_file is defined

- name: Save VSR config
  local_action:
    module: sros_config
    save: yes
    provider: "{{ cli }}"
