---
- block:
  - name: Get current version of VSD software to use it in loading correct vspk version
    command: echo $VSD_VERSION
    register: vsd_old_version
    remote_user: "root"

  - name: Print vsd_version output when verbosity >= 1
    debug: var=vsd_version verbosity=1
  when: (inventory_hostname == groups['vsds'][0] and vsd_sa_or_ha == "sa") or (inventory_hostname == groups['vsds'][1] and vsd_sa_or_ha == "ha")

- block:
  - name: Stop vsd services gracefully
    include_role:
      name: vsd-services-stop
    when:
    - inventory_hostname in groups['vsd_node2'] or inventory_hostname in groups['vsd_node3']
    remote_user: root
  
  - block:
    - name: Backup and Shutdown/Destroy Current vsd nodes 1 and 3
      include_role: 
        name: vsd-destroy
      vars:
        preserve_vsd_for_rollback: True
        rollback: False
    when: inventory_hostname in groups['vsd_node2'] or inventory_hostname in groups['vsd_node3']
  
  - block:
    - name: Shutdown/Destroy Current vsd node 2
      include_role: 
        name: vsd-destroy
      vars:
        preserve_vsd_for_rollback: False
        rollback: False
    when: inventory_hostname in groups['vsd_node1'] 
  when: vsd_sa_or_ha == 'ha'

- block:
  - name: Backup and Shutdown/Destroy Current vsd node 1  for SA
    include_role: 
      name: vsd-destroy
    vars:
      preserve_vsd_for_rollback: True
      rollback: False
  when: vsd_sa_or_ha == 'sa'

- name: Block access to VSD1 and VSD3 from VSD2
  command: "{{ item }}"
  remote_user: root
  delegate_to: "{{ groups['vsd_node1'][0] }}"
  run_once: true
  with_items: "{{ iptable_entries }}"
  when:
    - inventory_hostname not in groups['vsd_node1']
    - inventory_hostname not in groups['vsd_node3']
    - ("4.0.6" in vsd_migration_iso_file_name) or
      ("4.0.7" in vsd_migration_iso_file_name) or
      ("4.0.8" in vsd_migration_iso_file_name) or
      ("4.0.9" in vsd_migration_iso_file_name)

- name: Deploy VSD nodes with new version
  include_role:
    name: vsd-predeploy

- name: Wait for VSD ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1

- include: copy_backup_files.yml
  tags:
   - vcin
   - vsd

#TODO: 
#- name: Compare network information of VSD's across pre-uppgrade and upgrade

- name: Install VSD on new node(s)
  include_role:
    name: vsd-deploy

#TODO
#Add polling of VSD processes similar to VNS deploy instead of fix timeout
- name: Pause to wait for VSD processes to come up
  pause:
    minutes: 10

#TODO:
#-update vsd_post_upgrade_helper to include disabling VSD maintenance mode
- block:
  - name: Disable maintainance mode on all l3/l2 domains
    vsd_maintainance:
      vsd_auth:
        "{{ vsd_auth }}"
      state: disabled
      api_version: "{{ vsd_old_version.stdout }}"
    register: mode_status
    delegate_to: 127.0.0.1

  - name: Print vsd maintainance mode output when verbosity >= 1
    debug: var=mode_status verbosity=1

  - name: shut/noshut vswitch controller on vsc1 after disabling VSD maintenance mode
    sros_config:
      lines:
          - configure vswitch-controller shutdown
          - configure vswitch-controller no shutdown
      provider: 
        host: "{{ groups['vscs'][0] }}"
        username: "{{ vsc_user }}"
        password: "{{ vsc_password }}"
        transport: cli 
    register: vsc1_command_status
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"

  - debug: var=vsc1_command_statusa verbosity=1

  - name: shut/noshut vswitch controller on vsc2 after disabling VSD maintenance mode
    sros_config:
      lines:
          - configure vswitch-controller shutdown
          - configure vswitch-controller no shutdown
      provider: 
        host: "{{ groups['vscs'][1] }}"
        username: "{{ vsc_user }}"
        password: "{{ vsc_password }}"
        transport: cli 
    register: vsc2_command_status verbosity=1
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"

  - debug: var=vsc2_command_status verbosity=1

  - block:
    - name: read saved vsd purge time before upgrade
      command: cat "/tmp/backup-{{ groups['vsd_node2'][0] }}-latest/purge_time"
      register: purge_time_saved
      delegate_to: 127.0.0.1

    - debug: var=purge_time_saved.stdout verbosity=1

    - name: Update gateway purge timer to original value
      config_vsd_system:
        vsd_auth:
          "{{ vsd_auth }}"
        gateway_purge_time: "{{ purge_time_saved.stdout }}"
        api_version: "{{ vsd_old_version.stdout }}"
      register: update_time_status
      delegate_to: 127.0.0.1
    when: vsd_sa_or_ha == "ha"

  - block:
    - name: read saved vsd purge time before upgrade
      command: cat "/tmp/backup-{{ groups['vsds'][0] }}-latest/purge_time"
      register: purge_time_saved
      delegate_to: 127.0.0.1

    - debug: var=purge_time_saved.stdout verbosity=1

    - name: Update gateway purge timer to original value
      config_vsd_system:
        vsd_auth:
          "{{ vsd_auth }}"
        gateway_purge_time: "{{ purge_time_saved.stdout }}"
        api_version: "{{ vsd_old_version.stdout }}"
      register: update_time_status
      delegate_to: 127.0.0.1
    when: vsd_sa_or_ha == "sa"
  when: (inventory_hostname == groups['vsds'][0] and vsd_sa_or_ha == "sa") or (inventory_hostname == groups['vsds'][1] and vsd_sa_or_ha == "ha")
