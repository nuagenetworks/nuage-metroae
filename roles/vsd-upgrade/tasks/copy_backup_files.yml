- block:
  - name: Clean known_hosts of VSD's
    command: ssh-keygen -R "{{ mgmt_ip }}" -f /root/.ssh/known_hosts
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"
 
  - name: Inject ssh key of ansible_deployment_host to VSD if cloud-init did not work
    expect:
      command: "ssh-copy-id -i root@{{ mgmt_ip }}"
      responses:
        (?i)yes: "yes"
        (?i)password: "Alcateldc"
    remote_user: root
    delegate_to: localhost
  when: target_server_type == 'heat'

- name: Create a directory on VSD Node1
  file:  
    path: "/opt/vsd/data"
    state: directory
  when: inventory_hostname == groups['vsds'][0]
 
- name: Copy backup files from backup_machine to VSD Node1
  copy:
    src: "/tmp/backup/"
    dest: "/opt/vsd/data/"
  remote_user: root
  when: inventory_hostname == groups['vsds'][0]

- name: Delete log files from /opt/vsd/data/ directory
  shell: "rm -rf /opt/vsd/data/*.log"
  when: inventory_hostname == groups['vsds'][0]

- name: Get list of files in /opt/vsd/data/ directory
  find:
    path: "/opt/vsd/data/"
    pattern: "*.tar.gz"
  register: lst_files
  when: inventory_hostname == groups['vsds'][0]

- name: Verify  /opt/vsd/data/ directory contains exactly 3 files
  assert:
    that: "lst_files.examined == 3"
    msg: "/opt/vsd/data on VSD node1 contains more than 3 files"
  when: inventory_hostname == groups['vsds'][0]
