- block: 
  - name: Clean known_hosts of VSC's on "{{ target_server }}"
    command: ssh-keygen -R "{{ mgmt_ip }}" -f /root/.ssh/known_hosts
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"

  - name: Get output of 'show bof'
    sros_command:
      commands:
        - show bof
      provider: "{{ vsc_creds }}"
    register: bof_config
    delegate_to: localhost

  - name: Print 'show bof' when verbosity >= 1
    debug: var=bof_config.stdout[0] verbosity=1

  - name: Create local variable with bof config in json
    set_fact:
      bof_json: "{{ bof_config.stdout[0]|show_bof_to_json }}"

  - name: Print bof config in json  when verbosity >= 1
    debug: var=bof_json verbosity=1

  - name: Get current file version of image on VSC
    sros_command:
      commands:
        - file version "{{ bof_json['image_folder'] }}/cpm.tim"
      provider: "{{ vsc_creds }}"
    register: image
    delegate_to: localhost

  - name: Print image version when verbosity >= 1
    debug: var=image.stdout[0] verbosity=1

  - name: Create local variable with image version in json
    set_fact:
      version_json: "{{ image.stdout[0]|image_version_to_json }}"

  - name: Print image version in json  when verbosity >= 1
    debug: var=version_json verbosity=1

  - name: Copy new VSC image to VSC nodes
    expect:
      command: "{{ vsc_image_copy }}"
      responses:
        (?i)password: "admin"
      timeout: 240
    remote_user: "{{ ansible_sudo_username }}"
    delegate_to: "{{ ansible_deployment_host }}"

  - block:
    - name: Stop VSC guest VM
      virt: name={{ inventory_hostname }} state=destroyed
      delegate_to: "{{ target_server }}"
      remote_user: root

    - name: Restart VSC guest VM
      virt: name={{ inventory_hostname }} state=running
      delegate_to: "{{ target_server }}"
      remote_user: root
    when: target_server_type == 'kvm'

  - name: Reboot VSC VM
    os_server_actions:
      auth:
        "{{ os_auth }}"
      server: "{{ inventory_hostname }}"
      action: reboot
      wait: no
    delegate_to: 127.0.0.1
    when: target_server_type == 'heat'

  - name: Wait for VSC ssh to be ready
    local_action:
      module: wait_for
      port: "22"
      host: "{{ mgmt_ip }}"
      search_regex: OpenSSH
      delay: 1

  - name: Clean known_hosts of VSC's on "{{ target_server }}"
    command: ssh-keygen -R "{{ mgmt_ip }}" -f /root/.ssh/known_hosts
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"

  - name: Get output of 'show vswitch-controller xmpp-server detail'
    sros_command:
      commands:
        - show vswitch-controller xmpp-server detail
      provider: "{{ vsc_creds }}"
    register: xmpp_detail
    until: xmpp_detail.stdout[0].find('Functional') != -1
    retries: 5
    delay: 10
    delegate_to: localhost

  - name: Print 'show vswitch-controller xmpp-server detail' when verbosity >= 1
    debug: var=xmpp_detail verbosity=1

  - name: Create local variable with xmpp-server detail in json
    set_fact: xmpp_detail_json="{{ xmpp_detail.stdout[0]|xmpp_server_detail_to_json }}"

  - name: Print xmpp-server detail in json when verbosity >= 1
    debug: var=xmpp_detail_json verbosity=1

  - name: Create local variable for xmpp-server state
    set_fact: xmpp_server_state="{{ xmpp_detail_json['State'] }}"

  - name: Print xmpp-server state when verbosity >= 1
    debug: var=xmpp_server_state verbosity=1

  - name: Check for the expected xmpp-server state
    assert: { 
      that: "{{ expected_xmpp_server_state == xmpp_server_state }}",
      msg: "Invalid xmpp-server state ({{ xmpp_server_state }}) detected. Expected {{ expected_xmpp_server_state }}. Check 'show vswitch-controller xmpp-server details' on {{ inventory_hostname }}."
  }
  
  - name: Get output of 'show vswitch-controller vsd detail'
    sros_command:
      commands:
        - show vswitch-controller vsd detail
      provider: "{{ vsc_creds }}"
    register: vsd_detail
    delegate_to: localhost

  - name: Print 'show vswitch-controller vsd' when verbosity >= 1
    debug: var=vsd_detail verbosity=1

  - name: Verify VSD Node1 is found in vsd_detail
    assert:
      that: "'cna@{{ vsd_fqdn }}/{{ groups['vsds'][0].split('.')[0:1] | join('.') }}' in vsd_detail.stdout[0]"
      msg: "VSD Node1 could not be found in 'show vswitch-controller vsd detail'"

  - name: Verify VSD Node3 is found in vsd_detail
    assert:
      that: "'cna@{{ vsd_fqdn }}/{{ groups['vsds'][2].split('.')[0:1] | join('.') }}' in vsd_detail.stdout[0]"
      msg: "VSD Node3 could not be found in 'show vswitch-controller vsd detail'"
  when: inventory_hostname in groups['vscs']

- block:
  - name: Set upgrade complete flag to 1 for minor upgrade on vsd
    expect:
      command: "{{ minor_upgrade_cmd }}"
      responses:
        (?i)ye: "yes"
        (?i)yes: "yes"
      timeout: 100
    remote_user: root
    when: inventory_hostname == groups['vsds'][0]

  - name: Restart Jboss on VSD Node1
    shell: "monit restart jboss"
    remote_user: root
    when: inventory_hostname == groups['vsds'][0] or inventory_hostname == groups['vsds'][3]
  when: minor_upgrade == True
