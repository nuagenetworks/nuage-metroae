---
- name: Change XMPP connection to TLS on VSD
  command: /opt/vsd/bin/ejmode allow -y

- name: wait for ejabberd-status to become running
  monit_waitfor_service:
    name: "ejabberd-status"
    timeout_seconds: 600
    test_interval_seconds: 30

- name: wait for ejbca-status to become running
  monit_waitfor_service:
    name: "ejbca-status"
    timeout_seconds: 600
    test_interval_seconds: 30

- block:
  - name: Download pip installer
    command: curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py

  - name: Execute pip installer
    command: python get-pip.py

  - name: Install pexpect on VSD
    pip:
      name: pexpect

  # JvB TODO should default to '' (empty) such that we can use the same logic everywhere
  when: yum_proxy == 'NONE'

- block:
  - name: Download pip installer through proxy
    command: curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py

  - name: Execute pip installer through proxy
    command: python get-pip.py

  - name: Install pexpect on VSD through proxy
    pip:
      name: pexpect

  when: yum_proxy != 'NONE'
  environment:
    http_proxy: "{{ yum_proxy }}"
    https_proxy: "{{ yum_proxy }}"