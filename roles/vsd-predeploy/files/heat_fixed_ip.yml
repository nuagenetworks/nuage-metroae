heat_template_version: '2014-10-16'
parameters:
  vm_name:
    type: string
  image:
    type: string
  flavor:
    type: string
  vm_key_name:
    type: string
    description: Name of key-pair from #openstack keypair list
  mgmt_interface:
    type: json
    description: Dictionary with VM management inteface parameters (defined in build_vars.yml)

resources:
  mgmt_port:
    type: OS::Neutron::Port
    properties:
      network_id: {get_param: [mgmt_interface, network]}
      fixed_ips:
        - ip_address: {get_param: [mgmt_interface, ip]}
          subnet: {get_param: [mgmt_interface, subnet]}

  mycompute:
    type: OS::Nova::Server
    properties:
      name:     {get_param: vm_name}
      flavor:   {get_param: flavor}
      image:    {get_param: image}
      key_name: {get_param: vm_key_name}
      networks:
        - port: {get_resource: mgmt_port}

outputs:
  server_ip:
    description: Management IP address assigned to VM
    value: { get_attr: [mycompute, networks, {get_param: [mgmt_interface, network]}, 0]}
