- name: Clean known_hosts of VSD's
  command: ssh-keygen -R "{{ mgmt_ip }}" -f /root/.ssh/known_hosts
  delegate_to: "{{ ansible_deployment_host }}"
  remote_user: "{{ ansible_sudo_username }}"

- name: Verify if VSD TLS mode is set to allow
  command: /opt/vsd/bin/ejmode status
  delegate_to: "{{ item }}"
  register: ejmode
  remote_user: root
  with_items: "{{ groups['vsds'] }}"
  failed_when: "'allow' not in ejmode.stdout"
  run_once: true

- name: Verify if vsc user is connected to the VSD
  command: /opt/ejabberd/bin/ejabberdctl connected_users
  register: proxy_user
  remote_user: root
  delegate_to: "{{ groups['vsds'][0] }}"
  failed_when: "'{{ vsc1_user }}' not in proxy_user.stdout or '{{ vsc2_user }}' not in proxy_user.stdout"
  run_once: true
