- name: Find source file based on pattern
  find:
    path: "{{ unpack_zipped_files_dir | default(nuage_zipped_files_dir) }}"
    pattern: "{{ unpack_pattern }}"
    use_regex: "{{ unpack_pattern_regexp | default(False) }}"
    follow: yes
  register: unpack_src_file

- debug: var=unpack_src_file verbosity=1

- block:
  - name: Clean up any previous unzipped files
    file:
      name:  "{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}"
      state: absent
    remote_user: "{{ unzip_user }}"

  - name: Create subdirectory for unzipped files
    file:
      name: "{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}"
      state: directory
      mode: 0775
    remote_user: "{{ unzip_user }}"

  - name: Unpack {%if unpack_src_file.matched > 0 %}{{ unpack_src_file.files[0].path }}{%endif%} Archive
    unarchive:
      src: "{{ unpack_src_file.files[0].path }}"
      dest: "{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}"
      list_files: yes
      mode: 0775
      remote_src: yes
    register:  rc_nokia_vsr_archive
    # TODO: in ansible 2.2 does not work registering of dynamic variable name
    # with ansible 2.3 replace to
    #register: '{{ unpack_register_var }}'
    remote_user: "{{ unzip_user }}"

  - debug: var='{{ unpack_register_var }}' verbosity=1

  - block:
      - debug: var=rc_nokia_vsr_archive.files verbosity=1

      - name: Move file to root directory
        command: mv '{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}/{{ item }}' '{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}'
        remote_user: "{{ unzip_user }}"
        when: item.split(".")[-1] in ['txt','ova','qcow2']
        with_items: '{{rc_nokia_vsr_archive.files}}'

      - name: Delete unused VSR folder
        file:
          name: '{{ nuage_unzipped_files_dir }}/{{ unpack_target_folder }}/vm'
          state: absent
        remote_user: "{{ unzip_user }}"

    when: rc_nokia_vsr_archive is defined
  when: unpack_src_file.matched > 0
