---
- block:

  - name: Delete existing network uplink
    lineinfile:
      dest: "/etc/default/openvswitch"
      regexp: "^NETWORK_UPLINK_INTF="
      state: absent

  - name: Add network uplink config to vrs
    lineinfile:
      dest: "/etc/default/openvswitch"
      insertafter: uplink interface of the host
      line: "NETWORK_UPLINK_INTF={{ uplink_interface }}"

  - name: Add alubr0 to nova config
    lineinfile:
      dest: /etc/nova/nova.conf
      regexp: ovs_bridge=
      line: ovs_bridge=alubr0

  - name: Restart OpenStack compute
    service:
      name: openstack-nova-compute   
      state: restarted

  - name: Restart OVS
    service: 
      name: openvswitch
      state: restarted

  remote_user: "{{ target_server_username }}"
