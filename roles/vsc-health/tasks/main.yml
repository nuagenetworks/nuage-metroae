---
- include: report_header.yml

- name: Wait for VSC ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1
  tags:
    - vsc
    - vsc-deploy
    - vsc-health

- name: Clean known_hosts of VSC's
  command: ssh-keygen -R "{{ mgmt_ip }}"

# Without this, the run creates a false positive as it finds the files
# from the previous run
- name: Remove older failure_report.log files
  command: rm -f {{ failure_report_file_name }}

- name: Get output of 'show version'
  vsc_command:
    command: show version
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: sh_version

- name: Print 'show version' when verbosity >= 1
  debug: var=sh_version verbosity=1

- name: Write show version json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} {{ sh_version|to_nice_json }}\n"

- name: Get output of 'show router bgp summary'
  vsc_command:
    command: show router bgp summary
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: bgp_summary

- name: Print 'show router bgp summary' when verbosity >= 1
  debug: var=bgp_summary verbosity=1

- name: Create local variable with BGP Summary in json
  set_fact: bgp_summary_json="{{ bgp_summary.result|bgp_summary_to_json }}"

- name: Print BGP Summary in json when verbosity >= 1
  debug: var=bgp_summary_json verbosity=1

- name: Write BGP Admin State JSON to file
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} {{ bgp_summary_json|to_nice_json }}\n"

- name: Create local variable with BGP Admin State
  set_fact: bgp_admin_state="{{ bgp_summary_json['BGP Admin State'] }}"

- name: Print BGP Admin State when verbosity >= 1
  debug: var=bgp_admin_state verbosity=1

- name: Check for expected BGP Admin State
  assert: {
    that: "'{{ expected_bgp_admin_state }}' in bgp_admin_state",
    msg: "Unexpected BGP Admin State - {{ bgp_admin_state }}. Expected '{{ expected_bgp_admin_state }}'. Check output of 'show router bgp summary'."
  }
  ignore_errors: yes

- name: Create local variable for BGP Oper State
  set_fact: bgp_oper_state="{{ bgp_summary_json['BGP Oper State'] }}"

- name: Print BGP Oper State when verbosity >= 1
  debug: var=bgp_oper_state verbosity=1

- name: Check for expected BGP Oper State
  assert: {
    that: "'{{ expected_bgp_oper_state }}' in bgp_oper_state",
    msg: "Unexpected BGP Oper State - {{ bgp_oper_state }}. Expected '{{ expected_bgp_oper_state }}'. Check output of 'show router bgp summary'."
  }
  ignore_errors: yes

- name: Create local variable for BGP Peer Count
  set_fact: bgp_peer_count="{{ bgp_summary_json['Total Peers'] }}"

- name: Print BGP Peer Count when verbosity >= 1
  debug: var=bgp_peer_count verbosity=1

- name: Check for expected BGP Peer Count
  assert: {
    that: "{{ expected_num_bgp_peers | default(default_expected_num_bgp_peers) }} == {{ bgp_peer_count }}",
    msg: "Invalid BGP Peer count ({{ bgp_peer_count }}) detected. Expected '{{ expected_num_bgp_peers | default(default_expected_num_bgp_peers) }}'. Check 'show router bgp summary'."
  }
  ignore_errors: yes

- name: Get output of 'show vswitch-controller xmpp-server detail'
  vsc_command:
    command: show vswitch-controller xmpp-server detail
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: xmpp_detail

- name: Print 'show vswitch-controller xmpp-server detail' when verbosity >= 1
  debug: var=xmpp_detail verbosity=1

- name: Create local variable with xmpp-server detail in json
  set_fact: xmpp_detail_json="{{ xmpp_detail.result|xmpp_server_detail_to_json }}"

- name: Print xmpp-server detail in json when verbosity >= 1
  debug: var=xmpp_detail_json verbosity=1

- name: Write xmpp-server detail json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} {{ xmpp_detail_json|to_nice_json }}\n"

- name: Create local variable for xmpp-server state
  set_fact: xmpp_server_state="{{ xmpp_detail_json['State'] }}"

- name: Print xmpp-server state when verbosity >= 1
  debug: var=xmpp_server_state verbosity=1

- name: Check for the expected xmpp-server state
  assert: {
    that: "{{ expected_xmpp_server_state == xmpp_server_state }}",
    msg: "Invalid xmpp-server state ({{ xmpp_server_state }}) detected. Expected {{ expected_xmpp_server_state }}. Check 'show vswitch-controller xmpp-server details'."
  }
  ignore_errors: yes

- name: Create local variable for xmpp-server state
  set_fact: xmpp_server_state="{{ xmpp_detail_json['State'] }}"

- name: Print xmpp-server state when verbosity >= 1
  debug: var=xmpp_server_state verbosity=1

- name: Check for the expected xmpp-server state
  assert: {
    that: "{{ expected_xmpp_server_state == xmpp_server_state }}",
    msg: "Invalid xmpp-server state ({{ xmpp_server_state }}) detected. Expected {{ expected_xmpp_server_state }}. Check 'show vswitch-controller xmpp-server details'."
  }
  ignore_errors: yes

- name: Get output of 'show vswitch-controller vsd detail'
  vsc_command:
    command: show vswitch-controller vsd detail
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: vsd_detail

- name: Print 'show vswitch-controller vsd detail' when verbosity >= 1
  debug: var=vsd_detail verbosity=1

- name: Create local variable with vsd detail in json
  set_fact: vsd_detail_json="{{ vsd_detail.result|vsd_detail_to_json }}"

- name: Print vsd detail in json when verbosity >= 1
  debug: var=vsd_detail_json verbosity=1

- name: Write vsd detail json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} {{ vsd_detail_json|to_nice_json }}\n"

- name: Get output of 'show vswitch-controller vswitches'
  vsc_command:
    command: show vswitch-controller vswitches
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: show_vswitches

- name: Print output of 'show vswitch-controller vswitches' when verbosity >= 1
  debug: var=show_vswitches verbosity=1

- name: Create local variable with show vswitches output in json
  set_fact: show_vswitches_json="{{ show_vswitches.result|show_vswitches_to_json }}"

- name: Print show vswitches in json when verbosity >= 1
  debug: var=show_vswitches_json verbosity=1

- name: Write vswiches json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} {{ show_vswitches_json|to_nice_json }}\n"

- name: Check for the expected number of vswitches
  assert: {
    that: "{{ expected_num_vswitches | default(default_expected_num_vswitches) }} == {{ show_vswitches_json['No. of virtual switches'] }}",
    msg: "Invalid vswitch count ({{ show_vswitches_json['No. of virtual switches'] }}) detected. Expected {{ expected_num_vswitches | default(default_expected_num_vswitches) }}. Check 'show vswitch-controller vswitches'."
  }
  ignore_errors: yes

- name: Get output of 'show vswitch-controller vports type host'
  vsc_command:
    command: show vswitch-controller vports type host
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: show_host_vports

- name: Print output of 'show vswitch-controller vports type host' when verbosity >= 1
  debug: var=show_host_vports verbosity=1

- name: Create local variable with show host vports output in json
  set_fact: show_host_vports_json="{{ show_host_vports.result|show_host_vports_to_json }}"

- name: Print show host vports in json when verbosity >= 1
  debug: var=show_host_vports_json verbosity=1

- name: Write host vports json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} HOST VPORTS {{ show_host_vports_json|to_nice_json }}\n"

- name: Check for the expected number of host vports
  assert: {
    that: "{{ expected_num_host_vports | default(default_expected_num_host_vports) }} == {{ show_host_vports_json['No. of virtual ports'] }}",
    msg: "Invalid host vport count ({{ show_host_vports_json['No. of virtual ports'] }}) detected. Expected {{ expected_num_host_vports | default(default_expected_num_host_vports) }}. Check 'show vswitch-controller vports type host'."
  }
  ignore_errors: yes

- name: Get output of 'show vswitch-controller vports type vm'
  vsc_command:
    command: show vswitch-controller vports type vm
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: show_vm_vports

- name: Print output of 'show vswitch-controller vports type vm' when verbosity >= 1
  debug: var=show_vm_vports verbosity=1

- name: Create local variable with show vm vports output in json
  set_fact: show_vm_vports_json="{{ show_vm_vports.result|show_vm_vports_to_json }}"

- name: Print show vm vports in json when verbosity >= 1
  debug: var=show_vm_vports_json verbosity=1

- name: Write vm vports json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} VM VPORTS {{ show_vm_vports_json|to_nice_json }}\n"

- name: Check for the expected number of vm vports
  assert: {
    that: "{{ expected_num_vm_vports | default(default_expected_num_vm_vports) }} == {{ show_vm_vports_json['No. of virtual ports'] }}",
    msg: "Invalid vm vport count ({{ show_vm_vports_json['No. of virtual ports'] }}) detected. Expected {{ expected_num_vm_vports | default(default_expected_num_vm_vports) }}. Check 'show vswitch-controller vports type vm'."
  }
  ignore_errors: yes

- name: TODO sections 3.2.7, VRS-G Status
  assert: {
    that: true,
    msg: "TODO sections 3.2.7, VRS-G Status"
  }
  ignore_errors: yes

- name: Get output of 'show vswitch-controller gateway ports'
  vsc_command:
    command: show vswitch-controller gateway ports
    mgmt_ip: "{{ mgmt_ip }}"
    username: "{{ vsc_user | default('admin') }}"
    password: "{{ vsc_password | default('admin') }}"
  delegate_to: localhost
  register: show_gateway_ports

- name: Print output of 'show vswitch-controller gateway ports' when verbosity >= 1
  debug: var=show_gateway_ports verbosity=1

- name: Create local variable with show gateway ports output in json
  set_fact: show_gateway_ports_json="{{ show_gateway_ports.result|show_gateway_ports_to_json }}"

- name: Print show gateway ports in json when verbosity >= 1
  debug: var=show_gateway_ports_json verbosity=1

- name: Write gateway ports json to report
  nuage_append: filename="{{ report_path }}" text="{{ inventory_hostname }} GATEWAY VPORTS {{ show_gateway_ports_json|to_nice_json }}\n"

- name: Check for the expected number of gateway ports
  assert: {
    that: "{{ expected_num_gateway_ports | default(default_expected_num_gateway_ports) }} == {{ show_gateway_ports_json['No. of Ports'] }}",
    msg: "Invalid gateway port count ({{ show_gateway_ports_json['No. of Ports'] }}) detected. Expected {{ expected_num_gateway_ports | default(default_expected_num_gateway_ports) }}. Check 'show vswitch-controller gateway ports'."
  }
  ignore_errors: yes

- name: TODO section 3.2.9, vport-to-FIP associations
  assert: {
    that: true,
    msg: "TODO sections 3.2.9, vport-to-FIP associations"
  }
  ignore_errors: yes

- include: report_footer.yml
