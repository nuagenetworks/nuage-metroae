---
- name: Wait for VNS Utility VM ssh to be ready
  local_action:
    module: wait_for
    port: "22"
    host: "{{ mgmt_ip }}"
    search_regex: OpenSSH
    delay: 1
  delegate_to: "{{ target_server }}"
  remote_user: "{{ target_server_username }}"

- block:
  - name: Update /etc/hosts file on {{ target_server }}
    lineinfile:
      dest: /etc/hosts
      line: "{{ mgmt_ip }} {{ inventory_hostname }}"
    delegate_to: "{{ target_server }}"
    remote_user: "{{ target_server_username }}"
  when: not target_server_type | match("vcenter")

- name: Update /etc/hosts file
  blockinfile:
    dest: /etc/hosts
    block: |
      {% for host in groups['vnsutils']  %}
      {{ hostvars[host]['mgmt_ip'] }}    {{ host }}
      {% endfor %}
  remote_user: "root"

- name: Configure yum proxy
  lineinfile:
    dest: /etc/yum.conf
    regexp: "^proxy="
    line: "proxy={{ yum_proxy }}"
  remote_user: "root"
  when: not yum_proxy | match('NONE')

- name: Install NTP package on the vnsutil vm
  yum: name=ntp state=present
  remote_user: "root"

- name: Configure ntpd and ntpdate and local time zone
  include_role:
    name: common
    tasks_from: linux-ntp

- block:
  - name: Install dhcp package
    yum: name=dhcp state=present
    remote_user: "root"

  - name: Copy dhcp config
    template: src=dhcpd.conf.j2 backup=no dest=/etc/dhcp/dhcpd.conf
    remote_user: "root"

  - name: Restart dhcp service
    service:
      name: dhcpd
      state: restarted
    remote_user: "root"

  - name: Chkconfig of dhcpd
    command: chkconfig dhcpd on
    remote_user: "root"

  - name: Install dnsmasq package
    yum: name=dnsmasq state=present
    remote_user: "root"

  - name: Copy dnsmasq config
    template: src=dnsmasq.conf.j2 backup=no dest=/etc/dnsmasq.conf
    remote_user: "root"

  - name: Start dnsmasq
    service:
      name: dnsmasq
      state: started
    remote_user: "root"

  - name: Chkconfig of dnsmasq
    command: chkconfig dnsmasq on
    remote_user: "root"
  when: nsgv_ip is defined or nsgv_mac is defined or nsgv_host_name is defined
