---
- name: Pull facts on VRS target {{ inventory_hostname }}
  remote_user: "{{ target_server_username }}"
  action: setup

- name: Create temporary directory
  remote_user: "{{ target_server_username }}"
  file: path={{ temp_dir }}/{{ inventory_hostname }} state=directory

- name: Copy VRS packages to temporary directory for Redhat OS Family Distros
  remote_user: "{{ target_server_username }}"
  copy: src={{ vrs_package_path }}/{{ item }} dest={{ temp_dir }}/{{ inventory_hostname }}/{{ item }}
  with_items: "{{ vrs_package_file_name_list }}"
  when: not avrs

- name: Copy AVRS packages to temporary directory for Redhat OS Family Distros
  remote_user: "{{ target_server_username }}"
  copy: src={{ item }} dest={{ temp_dir }}/{{ inventory_hostname }}/{{ item | basename }}
  with_items: "{{ el7_avrs_package_files + el7_avrs_package_6wind_files + el7_avrs_package_6wind_va_files }}"
  when: ansible_os_family == "RedHat" and avrs

- name: Copy Selinux packages to temporary directory for RHEL7 and Centos7
  remote_user: "{{ target_server_username }}"
  copy: src={{ selinux_package_path }}/{{ item }} dest={{ temp_dir }}/{{ inventory_hostname }}/{{ item }}
  with_items: "{{ selinux_package_file_name_list }}" 
  when: selinux_package_path is defined and selinux_package_path != 'None'
 
- name: Install Nuage OpenVSwitch packages on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  apt: deb={{ temp_dir }}/{{ inventory_hostname }}/{{ item }} state=present
  with_items:
   - "{{ vrs_package_file_name_list }}"
  when: ansible_os_family == "Debian" 

- name: Remove any conflicting OpenVSwitch packages on RedHat OS family distros ( may break connectivity... )
  remote_user: "{{ target_server_username }}"
  yum: name="openvswitch*" state=absent
  when: ansible_os_family == "RedHat"

- name: Install Nuage OpenVSwitch packages on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  yum: name={{ temp_dir }}/{{ inventory_hostname }}/{{ item }} state=present
  with_items:
   - "{{ vrs_package_file_name_list }}"
  when: ansible_os_family == "RedHat" and not avrs

- name: Install AVRS packages using DKMS - may take several minutes...
  yum: name={{ temp_dir }}/{{ inventory_hostname }}/{{ item | basename }} state=present
  with_items: "{{ el7_avrs_package_6wind_files + el7_avrs_package_files + el7_avrs_package_6wind_va_files }}"
  remote_user: "{{ target_server_username }}"
  when: ansible_os_family == "RedHat" and avrs

- name: Install Selinux package for RHEL7 and Centos7
  remote_user: "{{ target_server_username }}"
  yum: name={{ temp_dir }}/{{ inventory_hostname }}/{{ item }} state=present
  with_items:
   - "{{ selinux_package_file_name_list }}"
  when: 
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version == '7' 
    - selinux_package_path is defined and selinux_package_path != 'None'

- name: Remove temporary directory
  remote_user: "{{ target_server_username }}"
  file: path={{ temp_dir }}/{{ inventory_hostname }} state=absent

- name: Update active controller in /etc/default/openvswitch file on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  lineinfile:
    dest: /etc/default/openvswitch
    regexp: "^ACTIVE_CONTROLLER="
    line: "ACTIVE_CONTROLLER={{ active_controller_addr }}"
  when: ansible_os_family == "RedHat"

- name: Update active controller in /etc/default/openvswitch-switch file on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  lineinfile:
    dest: /etc/default/openvswitch-switch
    regexp: "^ACTIVE_CONTROLLER="
    line: "ACTIVE_CONTROLLER={{ active_controller_addr }}"
  when: ansible_os_family == "Debian"

- name: Update standby controller in /etc/default/openvswitch file on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  lineinfile:
    dest: /etc/default/openvswitch
    regexp: "^STANDBY_CONTROLLER="
    line: "STANDBY_CONTROLLER={{ standby_controller_addr }}"
  when: ansible_os_family == "RedHat"

- name: Update standby controller in /etc/default/openvswitch-switch file on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  lineinfile:
    dest: /etc/default/openvswitch-switch
    regexp: "^STANDBY_CONTROLLER="
    line: "STANDBY_CONTROLLER={{ standby_controller_addr }}"
  when: ansible_os_family == "Debian"

- name: Update PERSONALITY to avrs
  remote_user: "{{ target_server_username }}"
  lineinfile:
    dest: /etc/default/openvswitch
    regexp: ^PERSONALITY
    line: "PERSONALITY=avrs"
  when: ansible_os_family == "RedHat" and avrs

- name: Restart OpenVSwitch Service on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  service: name=openvswitch state=restarted
  when: ansible_os_family == "RedHat" and not avrs

- block:
  - service: name=virtual-accelerator state=restarted
  - service: name=openvswitch state=restarted
  - service: name=libvirtd state=restarted
  remote_user: "{{ target_server_username }}"
  when: ansible_os_family == "RedHat" and avrs

- name: Restart OpenVSwitch Service on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  service: name=nuage-openvswitch-switch state=restarted
  when: ansible_os_family == "Debian"

- pause: seconds=20
