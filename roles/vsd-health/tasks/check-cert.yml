---
- block:
  - name: Create temporary file to download VSD certificate
    tempfile:
      state: file
      suffix: crt
    register: cert_tmpfile

  - name: Download VSD certificate
    shell: "openssl s_client -showcerts -connect {{inventory_hostname}}:8443 </dev/null 2>/dev/null|openssl x509 -outform PEM > {{ cert_tmpfile.path }}"

  - name: Check that VSD cert for {{inventory_hostname}} is valid for at least {{ cert_validity_secs | default(1209600) }} seconds from now
    openssl_certificate:
      path: "{{ cert_tmpfile.path }}"
      provider: assertonly
      valid_in: "{{ cert_validity_secs | default(1209600) }}" 
      subject_alt_name: "DNS:{{ vsd_fqdn }}"
    when: ansible_version.full | version_compare('2.4', '>=')
  tags: check-certs
