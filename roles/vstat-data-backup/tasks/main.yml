- name: Get the nfs shared folder details
  shell: "mount | grep nfs"
  register: nfs_folder
  remote_user: root

- block:
  - name: Verify backup folder path is nfs shared
    assert:
      that: vstat_nfs_backup_path[:-1] in nfs_folder.stdout
      msg:  "{{ vstat_nfs_backup_path }} is not nfs shared"
  when: vstat_nfs_backup_path[-1] == '/'
 
- block:
  - name: Verify backup folder path is nfs shared
    assert:
      that: vstat_nfs_backup_path in nfs_folder.stdout
      msg:  "{{ vstat_nfs_backup_path }} is not nfs shared"
  when: vstat_nfs_backup_path[-1] != '/'

- name: Pull facts of localhost
  action: setup
  connection: local
  remote_user: "{{ ansible_sudo_username }}"

- block:
  - name: Set name of backup directory
    set_fact: backup_dir_name="backup-{{ inventory_hostname }}-{{ ansible_date_time.iso8601_basic_short }}/"

  - name: Set name of vstat backup dir
    set_fact: 
      vstat_backup_dir: "{{ vstat_nfs_backup_path }}/{{ backup_dir_name }}"

  - name: Create backup dir
    file:
      dest: "{{ vstat_backup_dir }}"
      state: directory
    remote_user: root
 
  - name: Get the username running the playbooks
    local_action: command whoami
    register: username_on_the_host

  - debug: var=username_on_the_host
 
  - name: Create backup dir on ansible_deployment_host
    file:
      dest: "/tmp/{{ backup_dir_name }}"
      state: directory
      owner: "{{ username_on_the_host.stdout }}"
      group: "{{ username_on_the_host.stdout }}"
    remote_user: "{{ ansible_sudo_username }}"
    delegate_to: "{{ ansible_deployment_host }}"

  - name: Cleanup backup dir in elasticseach.yml file
    lineinfile:
      dest: "/etc/elasticsearch/elasticsearch.yml"
      regexp: "path.repo"
      state: absent
    remote_user: root

  - name: Configure backup location in elasticseach.yml file
    lineinfile:
      dest: "/etc/elasticsearch/elasticsearch.yml" 
      line: "path.repo: [{{ vstat_backup_dir }}]"
    remote_user: root

  - name: Add user permission to backup location
    file:
      dest: "{{ vstat_backup_dir }}" 
      owner: "elasticsearch"
      group: "elasticsearch"
      recurse: yes
    remote_user: root

  - name: Restart elasticsearch process
    systemd:
      name: elasticsearch
      state: restarted
    remote_user: root

  - name: Get elasticsearch current status
    systemd:
      name: elasticsearch
      state: started
    register: es_status
    remote_user: root

  - name: Check elasticsearch status is active
    assert: 
      that: es_status.status.ActiveState == 'active'
      msg: "Elasticserach process in not active after restart"

  - name: Wiat for elasticsearch process to come up
    pause:
      seconds: 20

  - name: Check elasticsearch process is running
    assert:
      that: es_status.status.SubState == 'running'
      msg: "Elasticsearch process is not running after restart"

  - name: Copy elasticsearch backup scritps
    copy: src={{ vstat_backup_scripts_path }}/{{ item }}
        dest=/tmp/
    with_items: "{{ vstat_backup_scripts_file_list }}"
    remote_user: root
  
  - name: Set the repo name to be created
    set_fact:
      repo_name: "{{ ansible_date_time.iso8601_basic_short }}"

  - name: Create a repository to backup ES data
    command: "python /tmp/{{ create_repo }}"
    remote_user: root 

  - name: Get the repo created by backup script
    command: "python /tmp/{{ show_repo }}"
    register: repo_path
    remote_user: root

  - name: Print contents of show_repo output when verbosity >= 1
    debug: var=repo_path verbosity=1

  - name: Verify repo is created
    assert:
      that: '"Error in getting repo" not in repo_path.stdout'
      msg: Failed to verify the repo created

  - name: Set the snapshot name to be created
    set_fact:
      snap_name: "{{ ansible_date_time.iso8601_basic_short }}"

  - name: Create snapshot with all indicies
    command: "python /tmp/{{ create_snapshot }}"
    register: snapshot
    remote_user: root

  - name: Print contents of create_snapshot output when verbosity >= 1
    debug: var=snapshot verbosity=1

  - name: Get the contents of created snapshot
    command: "python /tmp/{{ show_snapshot }}"
    register: snapshot_contents
    remote_user: root

  - name: Create local variable with snap_contents output to json
    set_fact: snapshot_contents_json="{{ snapshot_contents.stdout|snapshot_list_indices_to_json }}"

  - name: Print contents of snapshot_contents output when verbosity >= 1
    debug: var=snapshot_contents verbosity=1

  - block:
    - name: Verify the contents of the snapshot created
      assert:
        that: '"{{ item }}" in list_of_indices'
        msg: "{{ item }} index was not found"
      with_items: "{{ snapshot_contents_json['indices'] }}"
    when: list_of_indices is defined

  - block:
    - name: Get the list of all inices
      command: "python /tmp/{{ get_indices }}"
      remote_user: root
      register: indices_output

    - name: Verify the contents of the snapshot created
      assert:
        that: '"{{ item }}" in indices_output.stdout'
        msg: "{{ item }} index was not found"
      with_items: "{{ snapshot_contents_json['indices'] }}"
    when: list_of_indices is not defined

  - name: get the username running the deploy
    local_action: command whoami
    register: username_on_the_host
 
  - debug: var=username_on_the_host

  - name: Copy the elasticsearch backup folder to ansible_deployment_host
    command: "{{ transfer_backup }}"
    remote_user: "{{ username_on_the_host.stdout }}"
    delegate_to: "{{ ansible_deployment_host }}"

  - name: Create symbolic link to backup location
    file: dest="/tmp/backup-{{ inventory_hostname }}-latest" src="/tmp/{{ backup_dir_name }}"  state=link
    remote_user: "{{ ansible_sudo_username }}"
    delegate_to: "{{ ansible_deployment_host }}"

  - name: Create file to store repo and snapshot names to use them in migrate role
    copy:
      content: "repo-{{ repo_name | lower }}\nsnap-{{ snap_name | lower }}"
      dest: "/tmp/backup-{{ inventory_hostname }}-latest/repo_snapshot_name"
    remote_user: "{{ ansible_sudo_username }}"
    delegate_to: "{{ ansible_deployment_host }}"
  when: 
    - upgrade_from_version != '4.0.1' 

