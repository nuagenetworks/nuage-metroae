---

- name: Gathering info on VM
  connection: local
  vmware_guest:
    hostname: "{{ target_server }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    name: "{{ vm_name }}"
    validate_certs: no
    state: gatherfacts
  register: vm_facts
  ignore_errors: yes

- name: Verify that the VM is not running if not reachable
  assert:
    that: "not (vm_facts.failed is not defined and not node_reachable)"
    msg: "{{ vm_name }} is running on {{ target_server }} but is not reachable. Quitting."

- name: Verify that the VM is running if reachable
  assert:
    that: "not (vm_facts.failed is defined and node_reachable)"
    msg: "{{ vm_name }} is not running on {{ target_server }} but the address is reachable. Quitting."

- name: Set fact for node running
  set_fact:
    node_running: "{{ vm_facts.failed is not defined }}"
