---
- name: Get OSC IP from {{ inventory_hostname }}
  os_server_facts:
    auth:
      "{{ os_auth }}"
    server: "{{ inventory_hostname }}"
  register: osc_server
  delegate_to: 127.0.0.1

- name: Set OSC ip
  set_fact:
    osc_mgmt_ip: "{{ osc_server['ansible_facts']['openstack_servers'][0]['networks'][osc_network][0] }}"

- block:
  - name: Get infra server details from OS server facts
    os_server_facts:
      auth:
        "{{ os_auth }}"
      server: "{{ infra_server_name }}"
    register: infra_server
    delegate_to: 127.0.0.1

  - name: Set DNS/NTP server ip
    set_fact:
      infra_ip: "{{ infra_server['ansible_facts']['openstack_servers'][0]['private_v4'] }}"

  - name: Update DNS entries
    lineinfile:
      line: "{{ osc_mgmt_ip }}  {{ inventory_hostname }}"
      dest: "/etc/hosts"
    delegate_to: "{{ infra_ip }}"
    remote_user: "root"

  - name: Restart DNS service
    shell: service dnsmasq restart
    delegate_to: "{{ infra_ip }}"
    remote_user: "root"
  when: infra_server_name is defined

- name: Update /etc/hosts file on ansible host
  lineinfile:
    dest: /etc/hosts
    line: "{{ osc_mgmt_ip }}    {{ inventory_hostname }}"
  delegate_to: 127.0.0.1
  remote_user: "{{ ansible_sudo_username }}"

- name: Clean known_hosts of OSC's
  command: ssh-keygen -R "{{ osc_mgmt_ip }}"
  delegate_to: localhost

- name: Wait for OSC ssh to be ready
  include_role:
    name: common
    tasks_from: wait-for-ssh
  vars:
    ssh_host: "{{ osc_mgmt_ip }}"

- name: Pause for ssh port to be active
  pause:
    seconds: 10

- name: Query {{ target_server }} facts
  action: setup
  remote_user: "root"
  delegate_to: "{{ osc_mgmt_ip }}"

- name: Update /etc/hosts file on osc
  lineinfile:
    dest: /etc/hosts
    line: "{{ osc_mgmt_ip }}    {{ inventory_hostname }}"
  remote_user: "root"

- name: Update hostname
  template: src=network.j2 backup=no dest=/etc/sysconfig/network

- name: Add nameserver
  command: echo "{{ infra_ip }}" >> /etc/resolv.conf
  remote_user: "root"
  when: infra_server_name is defined


- name: Disable firewall
  service:
    name: firewalld
    enabled: no
  remote_user: "root"
  when:
    - ansible_os_family == 'RedHat'
  ignore_errors: yes

- name: Stop firewall
  service:
    name: firewalld
    state: stopped
  remote_user: "root"
  when:
    - ansible_os_family == 'RedHat'
  ignore_errors: yes

- name: Disable NetworkManager
  service:
    name: NetworkManager
    enabled: no
  remote_user: "root"
  ignore_errors: yes

- name: Stop NetworkManager
  service:
    name: NetworkManager
    state: stopped
  remote_user: "root"
  ignore_errors: yes

- name: Copy eth0 config to osc
  template: src=ifcfg-eth0.j2 backup=no dest=/etc/sysconfig/network-scripts/ifcfg-eth0
  remote_user: "root"

- name: Delete eht1 config on osc
  file:
    path: "/etc/sysconfig/network-scripts/ifcfg-eth1"
    state: absent
  remote_user: "root"

- name: Enable network
  service:
    name: network
    enabled: yes
  remote_user: "root"

- name: Start network
  service:
    name: network
    state: started
  remote_user: "root"
  ignore_errors: yes

- name: Pause
  pause:
    seconds: 5

- name: Install NTP if not present
  yum:
    name: ntp
    state: latest
  remote_user: "root"

- name: Configure ntpd and ntpdate and local time zone
  include_role:
    name: common
    tasks_from: linux-ntp-sync

- name: Load correspoing software repos for OpenStack Centos7
  yum:
    name: "{{ os_centos }}{{ nuage_os_release }}"
    state: present
  remote_user: "root"
  when:
    - ansible_distribution == 'CentOS'
    - ansible_distribution_major_version == '7'

- name: Copy Redhat repo file for RedHat images
  template:
    src={{ role_path }}/templates/redhat.repo.j2
    dest=/etc/yum.repos.d/rhel.repo
  remote_user: "root"
  when:
    - ansible_distribution == 'RedHat'

- name: Execute a yum update
  yum:
    name: '*'
    state: latest
  remote_user: "root"

- name: Install packstack packages
  yum:
    name: openstack-packstack
    state: present
  remote_user: "root"

- name: Install OpenStack packstack
  command: "{{ install_packstack }}"
  remote_user: "root"

- name: Copy Mysql compute query file to controller
  copy:
    src={{ role_path }}/files/del_compute.txt
    dest=/root/
  remote_user: "root"

- name: Delete compute node from controller
  shell: "mysql -u root < /root/del_compute.txt"
  remote_user: "root"

- name: Disable compute service on controller
  service:
    name: openstack-nova-compute
    enabled: no
  remote_user: "root"

- name: Stop the compute service on controller
  service:
    name: openstack-nova-compute
    state: stopped
  remote_user: "root"

- name: Copy Mysql netowrk query file to controller
  copy:
    src={{ role_path }}/files/del_network.txt
    dest=/root/
  remote_user: "root"

- name: Delete network,subnets,routers,ports from Neutron
  shell: "mysql -u root < /root/del_network.txt"
  remote_user: "root"

- name: Add * to Server Alias list
  lineinfile:
    dest: /etc/httpd/conf.d/15-horizon_vhost.conf
    insertafter: '## Server aliases'
    line: '  ServerAlias *'
  remote_user: "root"

- name: Restart httpd
  service:
    name: httpd
    state: restarted
  remote_user: "root"
