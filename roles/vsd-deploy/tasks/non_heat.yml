---
- block:
  - include: set-vsd-version.yml
    when: vsd_sa_or_ha | match ('ha')

  - include: manage-ssh-keys.yml
    when: vsd_sa_or_ha | match('ha')

  - name: Configure yum proxy
    lineinfile:
      dest: /etc/yum.conf
      regexp: "^proxy="
      line: "proxy={{ yum_proxy }}"
    when: not yum_proxy | match('NONE')

  - name: Execute a yum update
    yum:
      name: '*'
      state: latest
    when: yum_update

  - name: Disable cloud-init on VSD, to avoid boot time delays
    command: "{{ item }}"
    with_items:
      - systemctl disable cloud-init
      - systemctl disable cloud-init-local
      - systemctl disable cloud-config
      - systemctl disable cloud-final

  remote_user: "{{ vsd_username }}"

- name: Configure ntpd and ntpdate and local time zone
  include_role:
    name: common
    tasks_from: linux-ntp-sync

- block:

  - block:

    - name: Install VSD software on standalone node
      command: /opt/vsd/vsd-install.sh -t s -y
      when: not deploy_vcin

    - name: Install VCIN software on VCIN node
      command: /opt/vsd/vsd-install.sh -t v -y
      when: deploy_vcin

    when: vsd_sa_or_ha | match ('sa')

  - block:

    - name: Install VSD software on the first cluster node
      command: "{{ vsd_node1_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_1

    - name: Install VSD software on the second cluster node
      command: "{{ vsd_node2_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_2

    - name: Install VSD software on the third cluster node
      command: "{{ vsd_node3_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_3

    when: vsd_sa_or_ha | match('ha')

  - name: Set XMPP connection to allow both clear and TLS
    command: /opt/vsd/bin/ejmode allow -y
    when: not deploy_vcin

  remote_user: "{{ vsd_username }}"
