- block:

  - block:

    - name: Generate SSH keys
      shell: ssh-keygen -b 2048 -t rsa -f /root/.ssh/id_rsa -q -N ""
      args:
        creates: /root/.ssh/id_rsa
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Get generated SSH keys
      shell: cat ~/.ssh/id_rsa.pub
      register: ssh_key_lst
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Add SSH keys to authorized_keys file
      shell: "echo {{ item[1].stdout }} >> /root/.ssh/authorized_keys"
      delegate_to: "{{ item[0] }}"
      with_nested:
        - "{{ groups['vsds'] }}"
        - "{{ ssh_key_lst.results }}"

    when: vsd_major_version | int < 5

  - block:

    - name: Generate SSH keys
      shell: sudo -u vsd ssh-keygen -b 2048 -t rsa -f /home/vsd/.ssh/id_rsa -q -N ""
      args:
        creates: /home/vsd/.ssh/id_rsa
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Get generated SSH keys
      shell: cat /home/vsd/.ssh/id_rsa.pub
      register: ssh_key_lst
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    - name: Add SSH keys to authorized_keys file
      shell: "echo {{ item[1].stdout }} >> /home/vsd/.ssh/authorized_keys"
      delegate_to: "{{ item[0] }}"
      with_nested:
        - "{{ groups['vsds'] }}"
        - "{{ ssh_key_lst.results }}"

    - name: Change owner and permissions of VSD authorized keys
      file:
        path: /home/vsd/.ssh/authorized_keys
        owner: vsd
        group: hadoopusers
        mode: 0640
      delegate_to: "{{ item }}"
      with_items: "{{ groups['vsds'] }}"

    when: vsd_major_version | int >= 5

  when: inventory_hostname == vsd_cluster_node_1 or (inventory_hostname == vsd_cluster_node_3 and nuage_upgrade)
