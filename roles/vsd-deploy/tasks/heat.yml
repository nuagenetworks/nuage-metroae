---
- name: Set VSD IP address
  include: set-vsd-ip.yml

- name: Clean known_hosts of VSD's
  known_hosts:
    name: "{{ vsd_mgmt_ip }}"
    state: absent
  delegate_to: localhost
  no_log: True
  ignore_errors: True

- include: manage-infra-server.yml
  when: infra_server_name is defined

- name: Pause for ssh port to be active
  pause:
    seconds: 5

- block:
  - name: Query {{ target_server }} facts
    action: setup

  - name: Add a DNS server to eth0
    lineinfile:
      dest: /etc/sysconfig/network-scripts/ifcfg-eth0
      regexp: "DNS1="
      line: "DNS1={{ dns_server_list[0] }}"

  - name: Restart networking
    command: /etc/init.d/network restart

  - name: Setup VSD hostname
    hostname:
      name: "{{ hostname }}"

  - name: Configure yum proxy
    lineinfile:
      dest: /etc/yum.conf
      line: "proxy={{ yum_proxy }}"
    when: not yum_proxy | match('NONE')

  - name: Execute a yum update
    yum:
      name: '*'
      state: latest
    when: yum_update

  remote_user: "{{ vsd_username }}"

- include: set-vsd-version.yml

- include: manage-ssh-keys.yml
  when: vsd_sa_or_ha | match('ha')
  remote_user: "{{ vsd_username }}"

- name: Configure ntpd and ntpdate and local time zone
  include_role:
    name: common
    tasks_from: linux-ntp-sync

- block:
  - name: Install VSD software on standalone node
    command: /opt/vsd/vsd-install.sh -t s -y
    when: vsd_sa_or_ha | match('sa')

  - block:

    - name: Install VSD software on the first cluster node
      command: "{{ vsd_node1_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_1

    - name: Install VSD software on the second cluster node
      command: "{{ vsd_node2_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_2

    - name: Install VSD software on the thrid cluster node
      command: "{{ vsd_node3_install_cmd }}"
      when: inventory_hostname == vsd_cluster_node_3

    when: vsd_sa_or_ha | match('ha')

  - name: Set XMPP connection to allow both clear and TLS
    command: /opt/vsd/bin/ejmode allow -y
  remote_user: "{{ vsd_username }}"

- name: Disable cloud-init on VSD, to avoid boot time delays
  command: "{{ item }}"
  with_items:
    - systemctl disable cloud-init
    - systemctl disable cloud-init-local
    - systemctl disable cloud-config
    - systemctl disable cloud-final
  remote_user : "{{ vsd_username }}"
