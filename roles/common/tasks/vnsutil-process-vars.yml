---
- block: #VNS UTIL

  - block: #QCOW2

    - name: Find name of VNS UTIL QCOW2 File
      find: path="{{ nuage_unzipped_files_dir }}/vns/utils"  pattern="vns-util-*.qcow2" recurse=yes
      register: rc_vnsutil_file

    - debug: var=rc_vnsutil_file verbosity=1

    - name: Verify that a VNS UTIL QCOW2 file was found
      assert: {
        that: "{{ rc_vnsutil_file.matched }} > 0",
        msg: "Unable to find VNS UTIL QCOW2 image file"
        }

    - name: Register VNS UTIL QCOW2 variables with proper path and image locations for use in other playbooks
      set_fact:
        qcow2_path: "{{ rc_vnsutil_file.files[0].path | dirname }}"
        qcow2_file_name: "{{ rc_vnsutil_file.files[0].path | basename }}"
      when: rc_vnsutil_file.matched > 0

    when: myvnsutils | map(attribute='target_server_type') | list | issuperset(["kvm"])

  - block: #OVA

    - name: Find name of VNS UTIL OVA File
      find: path="{{ nuage_unzipped_files_dir }}/vns/utils"  pattern="vns-util-*.ova" recurse=yes
      register: rc_vnsutil_file

    - debug: var=rc_vnsutil_file verbosity=1

    - name: Verify that a VNS UTIL OVA file was found
      assert: {
        that: "{{ rc_vnsutil_file.matched }} > 0",
        msg: "Unable to find VNS UTIL OVA image file"
        }

    - name: Register VNS UTIL OVA variables with proper path and image locations for use in other playbooks
      set_fact:
        ova_path: "{{ rc_vnsutil_file.files[0].path | dirname }}"
        ova_file_name: "{{ rc_vnsutil_file.files[0].path | basename }}"
      when: rc_vnsutil_file.matched > 0

    when: myvnsutils | map(attribute='target_server_type') | list | issuperset(["vcenter"])

  when:
    - myvnsutils is defined
    - "'install' in vns_operations_list|default(['None'])"
  tags:
    - vns

- name: Set myvnsutil_check
  set_fact: myvnsutil_check={{myvnsutils is defined}}

- name: Assign empty list to myvnsutils if it is undefined 
  set_fact: myvnsutils= default([])
  when: not myvnsutil_check

- name: Create host_vars files for vnsutil
  template: src=vnsutil.j2 backup=no dest={{ playbook_dir }}/host_vars/{{ item.hostname }}
  with_items: "{{ myvnsutils }}"
  when: myvnsutil_check
