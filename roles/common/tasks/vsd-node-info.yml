- name: Resolve "{{ vsd_hostname }}"  to ip addr
  shell: host "{{ vsd_hostname }}" | awk '{print $3,$4}'
  register: ip_addr
  remote_user: "root"

- name: Check for ip addr in the registered var
  fail: msg="Could not resolve ip addr of "{{ vsd_hostname }}" "
  when: ip_addr.stdout | match("not found:")

- name: Get the vsd node info
  command: /opt/vsd/sysmon/showStatus.py
  register: vsd_info
  remote_user: root
  delegate_to: "{{ vsd_hostname }}"

- name: Set vsd deployment mode
  set_fact:
    vsd_sa_or_ha: "sa"
  when: "'Standalone' in vsd_info.stdout"

- name: Set vsd deployment mode
  set_fact:
    vsd_sa_or_ha: "ha"
  when: "'Clustered' in vsd_info.stdout"

- name: Extract vsd hostname when standalone
  set_fact:
    vsd_hostname_list: "{{ vsd_info.stdout | regex_findall('Host Name:\\s+(.*)')}}"
  when: vsd_sa_or_ha | match('sa')

- name: Extract vsd hostname when clustered
  set_fact:
    vsd_hostname_list: "{{ vsd_info.stdout | regex_findall('VSD Server Node:\\s+(.*)')}}"
  when: vsd_sa_or_ha | match('ha')
