---

- name: Check if required OS packages are installed
  command: rpm -q python-netaddr
  when: ansible_os_family | match("RedHat")
  delegate_to: "{{ ansible_deployment_host }}"
  remote_user: "{{ ansible_sudo_username }}"
  register: rpm_check
  ignore_errors: True

- block:
  - name: Install packages for RedHat OS family distros
    yum: name=python-netaddr state=present
    when: ansible_os_family == "RedHat"
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"
    environment:
      http_proxy: "{{ yum_proxy }}"
      https_proxy: "{{ yum_proxy }}"
  when: yum_proxy|default('NONE') != 'NONE' and rpm_check.rc == 1

- block:
  - name: Install packages for RedHat OS family distros
    yum: name=python-netaddr state=present
    when: ansible_os_family == "RedHat"
    delegate_to: "{{ ansible_deployment_host }}"
    remote_user: "{{ ansible_sudo_username }}"
  when: yum_proxy|default('NONE') == 'NONE' and rpm_check.rc == 1

- name: Install python-netaddr package for Debian OS family distros
  apt: name=python-netaddr state=present
  when: ansible_os_family == "Debian"
  delegate_to: "{{ ansible_deployment_host }}"
  remote_user: "{{ ansible_sudo_username }}"

- name: Verify that the ntp servers are dotted decimal notation
  assert:
    that: "'{{ item }}'|ipaddr"
    msg: "{{ item }} is not a valid NTP server IP address, quiting"
  with_items: "{{ ntp_server_list }}"
  when: ntp_server_list is defined
