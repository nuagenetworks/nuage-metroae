---
- name: Pull facts on vrs target {{ inventory_hostname }}
  remote_user: "{{ target_server_username }}"
  action: setup

- name: Enable optional rpms to install twisted core package on RedHat OS family distors
  blockinfile:
    dest: "/etc/yum.repos.d/redhat.repo"
    block: |
      [rhel-7-server-optional-rpms]
      name = Red Hat Enterprise Linux 7 Server - Optional (RPMs)
      Enabled=1
  remote_user: "{{ target_server_username }}"
  when:
    - ansible_distribution == "RedHat"
    - ansible_distribution_major_version == '7' 
     
- name: Add epel repository on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  yum_repository:
    name: epel
    description: EPEL YUM repo
    baseurl: http://download.fedoraproject.org/pub/epel/$releasever/$basearch/
  when: ansible_os_family == "RedHat"

- name: Upgrade all packages on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  yum:
    name: "*"
    state: latest
  when: ansible_os_family == "RedHat"

- name: Install VRS prerequisite packages on RedHat OS family distros
  remote_user: "{{ target_server_username }}"
  yum: name={{ item }} state=present
  with_items:
   - python-twisted-core
   - perl-JSON
   - vconfig
   - libvirt
   - qemu-kvm
   - python-six
  when: ansible_os_family == "RedHat" and not avrs

- block:
  - name: Disable SELinux ( may need to reboot host for this to take effect! )
    selinux: state=disabled
  - name: Install Linux-headers
    yum: name=kernel-headers-{{ ansible_kernel }},kernel-devel-{{ ansible_kernel }} state=present disable_gpg_check=true
  - name: Install DKMS 
    yum: name=dkms state=latest disable_gpg_check=true
  - name: Install 6Wind repo
    yum: name="http://repo.6wind.com/rpm/6wind-public-1.0-1.noarch.rpm" state=present disable_gpg_check=true
    environment:
      http_proxy: "{{ yum_proxy }}"
  - name: Install libvirt packages
    yum: name=qemu-kvm-rhev,libvirt,libvirt-python state=latest disable_gpg_check=true
  - name: Restart libvirtd
    service: name=libvirtd state=restarted
  remote_user: "{{ target_server_username }}"
  when: ansible_os_family == "RedHat" and avrs

- name: Upgrade all packages on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  apt:
    upgrade: dist
  when: ansible_os_family == "Debian"

- name: Install VRS prerequisite packages on Debian OS family distros
  remote_user: "{{ target_server_username }}"
  apt: name={{ item }} state=present
  with_items:
   - qemu-kvm
   - libvirt-bin
   - bridge-utils
   - libguestfs-tools
   - python-libvirt
   - python-twisted-core
   - python-yaml
   - python-six
   - libjson-perl
   - vlan
   - dkms
   - linux-headers-{{ ansible_kernel }}
  when: ansible_os_family == "Debian"
