---
- name: Ping VSTAT hostname
  command: ping -c 1 {{ hostname }}
  ignore_errors: yes
  register: ping_result
  delegate_to: localhost

- name: Assert no response to ping of VSTAT hostname
  assert:
    that: "ping_result.rc != 0"
    msg:  "Someone responded to ping of VSTAT hostname. Quitting."
  when: not target_server_type | match("kvm")

- name: Ping VSTAT IP address
  command: ping -c 1 {{ mgmt_ip }}
  ignore_errors: yes
  register: ping2_result
  delegate_to: localhost

- name: Assert no response to ping of VSTAT IP address
  assert:
    that: "ping2_result.rc != 0"
    msg:  "Someone responded to ping of VSTAT IP address. Quitting."
  when: not target_server_type | match("kvm")

- name: Verify that the myvsd section is defined
  assert:
    that: "groups['vsds'] is defined"
    msg: "vstat-deploy requires VSD information. Please add VSD information to build_vars.yml, re-run the build, then re-run the vstat-deploy. See examples for details."

- include: kvm.yml
  when: target_server_type | match("kvm")
  tags:
    - vstat
    - vstat-predeploy

- block:
  - name: Assert no response to ping of VStat hostname, unless vstat_running
    assert:
      that: "ping_result.rc != 0"
      msg:  "Someone responded to ping of VStat hostname. Quitting."
  - name: Assert no response to ping of VStat IP address, unless vstat_running
    assert:
      that: "ping2_result.rc != 0"
      msg:  "Someone responded to ping of VStat IP address. Quitting."
  when: target_server_type | match("kvm") and not vstat_running

- include: vcenter.yml
  when: target_server_type | match("vcenter")
  tags:
    - vstat
    - vstat-predeploy
