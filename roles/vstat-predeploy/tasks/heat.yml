---
- name: Display if skipping VSTAT predeploy
  debug:
    msg:
      - "****************************************************"
      - "Skipping VSTAT predeploy because it is already present"
      - "****************************************************"
  when: node_present

- block:

  - name: Get heat stack for fixed ip deployments
    set_fact:
      vstat_heat_template: "{{ role_path }}/files/heat_fixed_ip.yml"
    when: not dhcp

  - name: Get heat stack for dhcp based deployments
    set_fact:
      vstat_heat_template: "{{ role_path }}/files/vstat.yml"
    when: dhcp

  - name: Creating VSTAT stack
    register: create_stack
    os_stack:
      name: "{{ stack_name | default(inventory_hostname) }}"
      template: "{{ vstat_heat_template }}"
      auth:
        "{{ os_auth }}"
      parameters:
        vm_name: "{{inventory_hostname}}"
        image: "{{ vstat_image }}"
        flavor: "{{ vstat_flavor }}"
        mgmt_interface: "{{ mgmt_interface | to_json }}"
        vm_key_name: "{{ vm_key_name }}"
    delegate_to: "{{ ansible_deployment_host }}"
  - debug: var=create_stack['stack']['outputs'][0]['output_value']

  - name: Update /etc/hosts file on ansible host
    lineinfile:
      dest: /etc/hosts
      line: "{{ create_stack['stack']['outputs'][0]['output_value'] }}    {{ inventory_hostname }}"
    delegate_to: "{{ ansible_deployment_host }}"

  when: not node_present
