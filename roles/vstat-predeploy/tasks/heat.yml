---
# TODO:
# Check for existing stack or vms

- name: Display if skipping VSTAT predeploy
  debug:
    msg:
      - "******************************************************"
      - "Skipping VSTAT predeploy because it is already present"
      - "******************************************************"
  when: node_present

- block:

  - name: Get the public key for the current user
    local_action: command cat "{{ user_ssh_pub_key }}"
    register: current_user_ssh_key

  - name: Get heat stack for fixed ip deployments
    set_fact:
      vstat_heat_template: "{{ role_path }}/files/vstat_fixed.yml"
    when: dhcp == False

  - name: Get heat stack for dhcp based deployments
    set_fact:
      vstat_heat_template: "{{ role_path }}/files/vstat.yml"
    when: dhcp == True

  - name: Creating VSD stack
    register: create_stack
    os_stack:
      name: "{{ stack_name | default(inventory_hostname) }}"
      template: "{{ vstat_heat_template }}"
      auth:
        "{{ os_auth }}"
      parameters:
        vm_name: "{{inventory_hostname}}"
        vstat_image: "{{ vstat_image }}"
        vstat_flavor: "{{ vstat_flavor }}"
        vstat_network: "{{ vstat_network }}"
        vstat_subnet: "{{ vstat_subnet | default('NONE') }}"
        mgmt_ip: "{{ mgmt_ip | default('NONE') }}"
        ssh_key: "{{ current_user_ssh_key.stdout }}"
    delegate_to: 127.0.0.1
  - debug: var=create_stack['stack']['outputs'][0]['output_value']

  when: not node_present
