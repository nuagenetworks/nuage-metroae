---
- hosts: localhost
  pre_tasks:
    - name: Check for Ansible version
      assert:
        that: "ansible_version.full | version_compare('2.4', '>=')"
        msg:  "Ansible version 2.4 and above are required. Found Ansible version {{ansible_version.full}}"

    - name: Set build_vars variable
      set_fact:
        build_vars: "{{ build_vars_file | default ('build_vars.yml') }}"
      tags:
        - always

    - name: Check YAML syntax
      yaml_checker:
        path: "{{ build_vars }}"

    - name: Check build_vars.yml
      build_vars_checker:
        path: "{{ build_vars }}"

    - name: Include build variable files
      include_vars: "{{ build_vars }}"
      tags:
        - always

    - name: Include user credential file
      include_vars: "{{ user_creds_file | default('user_creds.yml') }}"
      tags: always
  tasks: 
    - include_role:
        name: common
        tasks_from: validate-build-vars
    - include_role:
        name: build
    
- hosts: vrss
  gather_facts: no
  pre_tasks:
    - name: Get list of VRSs that require libnetwork to be installed on them
      delegate_to: localhost
      get_libn_host_list:
        path: "{{ build_vars_file | default ('build_vars.yml') }}"
      register: rel_vrss
      run_once: True
  roles:
    - { role: check_vrs_prereqs, when: inventory_hostname in rel_vrss.meta }
