- name: Get output of 'show vswitch-controller vswitches detail'
  sros_command:
    commands:
      - "show vswitch-controller vswitches vs-ip {{ nsgv_ip }} detail"
    provider:
      host: "{{ groups['vscs'][0] }}"
      username: "{{ vsc_username | default(vsc_default_username) }}"
      password: "{{ vsc_password | default(vsc_default_password) }}"
  delegate_to: localhost
  register: nsg_detail
  until: "nsg_detail.stdout[0] | regex_search('JSON Conn. State\\s+: Up') and nsg_detail.stdout[0] | regex_search('Uptime\\s+: [0-9]+d [0-9][0-9]:[0-9][0-9]:[1-9]')"
  retries: 40
  delay: 30
  when: bootstrap_method != 'none'

- block:

  - name: Format VSD auth for VSPK module
    set_fact:
      vspk_auth:
        api_username: "{{ vsd_auth.username }}"
        api_password: "{{ vsd_auth.password }}"
        api_enterprise: "{{ vsd_auth.enterprise }}"
        api_url: "{{ vsd_auth.api_url }}"
    no_log: True

  - name: Get Enterprise from VSD
    connection: local
    nuage_vspk:
      auth: "{{ vspk_auth }}"
      type: Enterprise
      command: find
      properties:
        name: "{{ zfb_nsg.nsg_organization }}"
    register: nuage_enterprise

  - name: Get NSGateway from VSD
    connection: local
    nuage_vspk:
      auth: "{{ vspk_auth }}"
      type: NSGateway
      command: find
      parent_id: "{{ nuage_enterprise.id }}"
      parent_type: Enterprise
      properties:
        name: "{{ zfb_nsg.nsg_name }}"
    register: nuage_nsg_status
    until: "nuage_nsg_status.entities[0].operationStatus == 'CONNECTED'"
    retries: 40
    delay: 30

  when: bootstrap_method == 'zfb_metro'
