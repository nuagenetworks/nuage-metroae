---
- hosts: primary_vsds
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Run vsd-prepare-replication-master-cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master-cluster.sh"
      when: vsd_standby | default(false)

- hosts: vsd_ha_node1
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Run vsd-prepare-replication-master on first cluster
      command: "/opt/vsd/bin/vsd-prepare-replication-master.sh -a {{ groups['vsd_standby_node1'][0] }} -b {{ groups['vsd_standby_node2'][0] }} -c {{ groups['vsd_standby_node3'][0] }}"
      retries: 15
      delay: 10
      register: result
      until: result.rc == 0
      when:
        - vsd_standby | default(false)

- hosts: vsd_standby_node1
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Clean known_hosts of Standby VSD (ignoring errors)
      known_hosts:
        name: "{{ inventory_hostname }}"
        state: absent
      delegate_to: localhost
      no_log: True
      ignore_errors: True

    - name: Wait for VSD ssh to be ready
      include_role:
        name: common
        tasks_from: wait-for-ssh
      vars:
        ssh_host: "{{ inventory_hostname }}"
        host_username: "{{ vsd_default_username }}"

    - name: Create data directory on first standby vm
      file:
        path: "/opt/vsd/data"
        state: directory
      when:
        - vsd_standby | default(false)

- hosts: localhost
  tasks:
    - name: Create vsd backup directory for localhost
      file:
        path: /tmp/vsdback
        state: directory
      when:
        - vsd_standby | default(false)

- hosts: vsd_ha_node1
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Transfer data from first VSD to host machine
      synchronize:
        src: /tmp/backup/
        dest: /tmp/vsdback
        mode: pull
        rsync_opts:
          - "--omit-dir-times"
      when:
        - vsd_standby | default(false)

- hosts: vsd_standby_node1
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Transfer data from host machine to first standby vm
      synchronize:
        dest: /opt/vsd/data/
        src: /tmp/vsdback/
        mode: push
      when:
        - vsd_standby | default(false)

- hosts: standby_vsds
  gather_facts: no
  pre_tasks:
    - name: Set cluster flag
      set_fact:
        vsd_standby_cluster: true
      when:
        - vsd_standby | default(false)
  roles:
    - vsd-deploy

- hosts: standby_vsds
  gather_facts: no
  tasks:
    - include_role:
        name: vsd-deploy
        tasks_from: vsd_security_hardening.yml

- hosts: vsd_standby_node1
  remote_user: "{{ vsd_custom_username | default(vsd_default_username) }}"
  become: "{{ 'no' if vsd_custom_username | default(vsd_default_username) == 'root' else 'yes' }}"
  vars:
    ansible_become_pass: "{{ vsd_custom_password | default(vsd_default_password) }}"
  tasks:
    - name: Run the replication script on first standby cluster
      command: "/opt/vsd/bin/vsd-start-replication-slave -m {{ groups['vsd_ha_node1'][0] }}"
      when:
        - vsd_standby | default(false)
