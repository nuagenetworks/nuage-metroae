# Rolling Back or Restoring VSD

In certain cases, you can use MetroAE to rollback or restore a stand-alone VSD or VSD cluster to its original version outside of the normal upgrade path. 

## Use Cases

A. Your upgrade has failed and you want to roll back to the pre-upgrade original version of the VSD without losing your VSD configuration.

B. Your existing VSD has failed and you want to restore it to the original version without losing your VSD configuration.

In both of these use cases, if the prerequisites, below, are met, MetroAE can help.

## Prerequisites

Before rolling back or restoring a VSD configuration, you must meet the following prerequisites: 

* You must have a recent backup of the original VSD database available.
  * If you were using MetroAE for the upgrade, the upgrade must have proceeeded past the point where the VSD database was backed up.
    * By default, MetroAE stores your VSD backup in the “backup” subdirectory under the path you specified for the `nuage_unzipped_files_dir` variable in common.yml. If you find a backup in this location, you can proceed with the rollback/restore. 
    * If you have configured the variable `metro_backup_root` in *upgrade.yml*, you can check for the backup in that location. `metro_backup_root` is an optional variable you might not have defined. If you find the backup, you can proceed with the rollback/restore.
  * If you were not using MetroAE, you must have a backup available that was generated by some other method.
* You must have the VSD image file, e.g. qcow2, for the original version to restore.
* You must configure a deployment for MetroAE to operate on.
  * If you were using MetroAE for the upgrade, you can start with the deployment that you configured for the upgrade - or make a copy of it and start there.
  * If you were not using MetroAE, you must create a new deployment.
  * The `nuage_unzipped_files_dir` variable in your deployment's `common.yml` file must be set to point to the location where the original VSD image file can be found, e.g. 6.0.3 images.
  * If the original VMs are still on the hypervisor, the VSD VM names in your deployment's `vsds.yml` file must be set to new, unique values. If you have completely destroyed the original VMs, you can use the original VM names.
  
## Steps

If all of these prerequisites and assumptions are true, perform the following steps to rollback/restore a VSD configuration: 

#### 1. Shut down all running VSDs.

* The VSDs that are being rolled back or restored cannot be running. Shut them down manually using your hypervisor's controls. Optionally undefine or delete them from disk. 
  
#### 2. Configure or create a new deployment as if you intend to install the original version.

* Set the `nuage_unzipped_files_dir` variable in `common.yml` to point to the original version image.
* If necessary, provide unique VM names in `vsds.yml`.
  
#### 3. Run the following command to bring up new copies of the original VMs (e.g. 5.4.1).

`metroae-container install vsds predeploy <deployment name>`

#### 4. Manually copy (via scp) the pre-upgrade backup to /opt/vsd/data on VSD 1.

#### 5. Run the following command to start the installation of the VSD software on the VSD VM. This will also restore the backup that you copied to the first VSD.

`metroae-container install vsds deploy <deployment name>`

#### 6. Run the following command to run sanity and connectivity checks on the VSDs: 

`metroae-container install vsds postdeploy <deployment name>`

At this point, your original VSD configuration should be restored and up and running.

## Questions, Feedback, and Contributing

Get support via the [forums](https://devops.nuagenetworks.net/forums/) on the [MetroAE site](https://devops.nuagenetworks.net/).  
Ask questions and contact us directly at [devops@nuagenetworks.net](mailto:devops@nuagenetworks.net "send email to nuage-metro project").

Report bugs you find and suggest new features and enhancements via the [GitHub Issues](https://github.com/nuagenetworks/nuage-metroae/issues "nuage-metroae issues") feature.

You may also [contribute](../CONTRIBUTING.md) to MetroAE by submitting your own code to the project.
